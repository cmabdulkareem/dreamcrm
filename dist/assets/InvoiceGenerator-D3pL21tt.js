import{r as i,A as J,c as f,d as v,y as m,j as e,n as k,P as K,G as W,C as p,z as g,I as S,B as C,ai as X,H as Y}from"./index-BRRNp47y.js";const ee=()=>{const{selectedBrand:d}=i.useContext(J),[y,I]=i.useState(""),[D,j]=i.useState([]),[z,T]=i.useState(!1),[x,b]=i.useState(null),[c,h]=i.useState([{description:"",quantity:1,rate:0,amount:0}]),[r,l]=i.useState({invoiceDate:new Date().toISOString().split("T")[0],dueDate:"",tax:0,discount:0,notes:"",terms:"",status:"Draft"}),[P,R]=i.useState(0),[$,G]=i.useState(0),[q,A]=i.useState(!1),[o,U]=i.useState(null),[_,E]=i.useState(!1);i.useEffect(()=>{const s=new URLSearchParams(window.location.search).get("edit");s&&(U(s),Q(s))},[]);const Q=async t=>{E(!0);try{const a=(await f.get(`${v}/invoices/${t}`,{withCredentials:!0})).data;b(a.customer),h(a.items),l({invoiceDate:a.invoiceDate.split("T")[0],dueDate:a.dueDate?a.dueDate.split("T")[0]:"",tax:a.tax,discount:a.discount,notes:a.notes,terms:a.terms,status:a.status})}catch(s){console.error("Error fetching invoice for edit:",s),m.error("Failed to load invoice for editing")}finally{E(!1)}};i.useEffect(()=>{const t=setTimeout(()=>{y.length>2?O():j([])},500);return()=>clearTimeout(t)},[y]);const O=async()=>{T(!0);try{const t=`${v}/customers/converted?includeStudents=true`,s=await f.get(t,{withCredentials:!0}),n=(s.data.customers||s.data).filter(u=>{const w=u.fullName||`${u.firstName} ${u.lastName}`,F=u.phone||u.phone1,L=y.toLowerCase();return w.toLowerCase().includes(L)||F&&F.includes(L)}).slice(0,5);j(n)}catch(t){console.error("Search error:",t)}finally{T(!1)}},V=t=>{b(t),I(""),j([])},N=(t,s,a)=>{const n=[...c];n[t][s]=a,(s==="quantity"||s==="rate")&&(n[t].amount=n[t].quantity*n[t].rate),h(n)},H=()=>{h([...c,{description:"",quantity:1,rate:0,amount:0}])},M=t=>{if(c.length>1){const s=c.filter((a,n)=>n!==t);h(s)}};i.useEffect(()=>{const t=c.reduce((u,w)=>u+w.amount,0);R(t);const s=parseFloat(r.tax)||0,a=parseFloat(r.discount)||0,n=t*s/100;G(t+n-a)},[c,r.tax,r.discount]);const B=async t=>{var s,a;if(t.preventDefault(),!x){m.error("Please select a customer");return}if(!d){m.error("Please select a brand from the header");return}A(!0);try{const n={...r,customer:x._id,items:c,subTotal:P,totalAmount:$,brand:(d==null?void 0:d._id)||(d==null?void 0:d.id)};o?(await f.patch(`${v}/invoices/${o}`,n,{withCredentials:!0}),m.success("Invoice updated successfully!"),setTimeout(()=>window.location.href="/finance/invoices",1500)):(await f.post(`${v}/invoices`,n,{withCredentials:!0}),m.success("Invoice generated successfully!"),h([{description:"",quantity:1,rate:0,amount:0}]),b(null),l({invoiceDate:new Date().toISOString().split("T")[0],dueDate:"",tax:0,discount:0,notes:"",terms:"",status:"Draft"}))}catch(n){console.error("Invoice submission error:",n),m.error(((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||`Failed to ${o?"update":"generate"} invoice`)}finally{A(!1)}};return _?e.jsx("div",{className:"flex justify-center p-10",children:e.jsx(k,{})}):e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsx(K,{title:o?"Update Invoice":"Generate Invoice",description:o?"Edit existing invoice":"Create a new invoice"}),e.jsx(W,{pageTitle:o?`Update Invoice #${o.substring(o.length-4)}`:"Generate Invoice"}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(p,{title:"Customer Information",children:x?e.jsxs("div",{className:"flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 dark:text-white",children:x.fullName}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:x.email}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:x.phone1})]}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>b(null),children:"Change"})]}):e.jsxs("div",{className:"relative",children:[e.jsx(g,{required:!0,children:"Search Customer"}),e.jsx(S,{placeholder:"Search by name or phone...",value:y,onChange:t=>I(t.target.value)}),z&&e.jsx("div",{className:"absolute right-3 top-9",children:e.jsx(k,{size:"sm"})}),D.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg dark:bg-gray-800 dark:border-gray-700",children:D.map(t=>e.jsxs("div",{className:"p-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 border-b last:border-0 border-gray-100 dark:border-gray-700",onClick:()=>V(t),children:[e.jsx("p",{className:"font-medium text-gray-800 dark:text-white",children:t.fullName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[t.email," | ",t.phone1]})]},t._id))})]})})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(p,{title:"Invoice Details",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{required:!0,children:"Invoice Date"}),e.jsx(S,{type:"date",value:r.invoiceDate,onChange:t=>l({...r,invoiceDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(g,{children:"Due Date"}),e.jsx(S,{type:"date",value:r.dueDate,onChange:t=>l({...r,dueDate:t.target.value})})]})]})})})]}),e.jsxs(p,{title:"Line Items",children:[e.jsx("div",{className:"overflow-x-auto -mx-6",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-700 text-white",children:[e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-20 text-center",children:"Qty"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-28 text-right",children:"Rate"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-28 text-right",children:"Amount"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-16 text-center"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:c.map((t,s)=>e.jsxs("tr",{className:"hover:bg-gray-50/30 transition-colors",children:[e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"text",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-[13px] text-gray-900 dark:text-gray-100 font-medium",placeholder:"Item description",value:t.description,onChange:a=>N(s,"description",a.target.value)})}),e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"number",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-center text-[13px] text-gray-900 dark:text-gray-100",value:t.quantity,onChange:a=>N(s,"quantity",parseFloat(a.target.value)||0),min:"1"})}),e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"number",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-right text-[13px] text-gray-900 dark:text-gray-100",value:t.rate,onChange:a=>N(s,"rate",parseFloat(a.target.value)||0),min:"0"})}),e.jsx("td",{className:"px-5 py-2 text-right font-semibold text-[13px] text-gray-900 dark:text-gray-100",children:t.amount.toLocaleString()}),e.jsx("td",{className:"px-5 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>M(s),className:"text-gray-400 hover:text-red-500 transition-colors p-1",children:e.jsx(X,{className:"size-4"})})})]},s))})]})}),e.jsx("div",{className:"mt-4",children:e.jsxs(C,{type:"button",variant:"outline",size:"sm",onClick:H,className:"flex items-center text-xs h-8",children:[e.jsx(Y,{className:"size-3.5 mr-1.5"}),"Add Row"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsx("div",{children:e.jsx(p,{title:"Notes & Terms",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-[12px]",children:"Customer Notes"}),e.jsx("textarea",{className:"w-full p-2.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-[13px] focus:ring-1 focus:ring-brand-500 outline-none transition-all",rows:"2",value:r.notes,onChange:t=>l({...r,notes:t.target.value}),placeholder:"Thanks for your business"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-[12px]",children:"Terms & Conditions"}),e.jsx("textarea",{className:"w-full p-2.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-[13px] focus:ring-1 focus:ring-brand-500 outline-none transition-all italic",rows:"2",value:r.terms,onChange:t=>l({...r,terms:t.target.value}),placeholder:"Please pay by the due date"})]})]})})}),e.jsx("div",{children:e.jsx(p,{title:"Summary",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Sub Total"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-medium",children:P.toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Tax (%)"}),e.jsx("div",{className:"w-20",children:e.jsx("input",{type:"number",className:"w-full p-1.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-right text-[13px] focus:ring-1 focus:ring-brand-500 outline-none",value:r.tax,onChange:t=>l({...r,tax:t.target.value})})})]}),e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Discount (Amt)"}),e.jsx("div",{className:"w-20",children:e.jsx("input",{type:"number",className:"w-full p-1.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-right text-[13px] focus:ring-1 focus:ring-brand-500 outline-none text-red-500",value:r.discount,onChange:t=>l({...r,discount:t.target.value})})})]}),e.jsx("div",{className:"pt-2 border-t border-gray-100 dark:border-gray-800",children:e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"text-gray-900 dark:text-white font-bold text-[14px]",children:"Total"}),e.jsx("span",{className:"text-brand-600 dark:text-brand-400 font-bold text-xl",children:$.toLocaleString("en-IN",{style:"currency",currency:"INR"})})]})}),e.jsxs("div",{className:"pt-4",children:[e.jsx(C,{type:"submit",variant:"primary",className:"w-full py-3 h-12 rounded shadow-sm hover:shadow transition-all font-bold text-[15px]",disabled:q,children:q?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(k,{size:"sm"}),e.jsx("span",{children:"Processing..."})]}):o?"Update Invoice":"Generate Invoice"}),o&&e.jsx("button",{type:"button",onClick:()=>window.location.href="/finance/invoices",className:"w-full mt-2 py-2 text-sm text-gray-500 hover:text-gray-700 transition-colors",children:"Discard Changes"}),e.jsxs("p",{className:"text-center text-[11px] text-gray-400 mt-3 italic",children:["* ",o?"Changes will be applied immediately.":"Stored as Draft by default."]})]})]})})})]})]})]})};export{ee as default};
