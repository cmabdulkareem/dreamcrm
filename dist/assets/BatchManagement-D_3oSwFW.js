import{ab as J,i as W,F as q,k as U,r as c,d as I,e as $,j as e,s as V,y as f,l as Y,M as G,B as P,H as _,I as z,U as Q,A as X,E as Z,N as ee,D as te,t as re}from"./index-BTKtjo01.js";import{S as ae}from"./group-CAvlO6Ko.js";function se({batchId:d}){const{user:b}=J(),i=W(b)||q(b)||U(b),[o,h]=c.useState([]),[v,D]=c.useState(!0),[u,A]=c.useState(!1),[E,S]=c.useState(null),k={studentId:"",studentName:"",dob:"",phoneNumber:"",parentPhoneNumber:""},[l,y]=c.useState(k),[p,B]=c.useState(k);c.useEffect(()=>{C()},[d]);const C=async()=>{try{D(!0);const a=await I.get(`${$}/batches/${d}/students`,{withCredentials:!0});h(a.data.students)}catch(a){console.error("Error fetching students:",a)}finally{D(!1)}},m=async a=>{if(a.preventDefault(),!l.studentName||!l.phoneNumber){f.error("Student Name and Phone Number are required.");return}try{const x=await I.post(`${$}/batches/${d}/students`,l,{withCredentials:!0});h([...o,x.data.student]),A(!1),y(k),f.success("Student added successfully!")}catch{f.error("Failed to add student.")}},N=async a=>{if(a.preventDefault(),!p.studentName||!p.phoneNumber){f.error("Student Name and Phone Number are required.");return}try{const x=await I.put(`${$}/batches/students/${E}`,p,{withCredentials:!0});h(o.map(r=>r._id===E?x.data.student:r)),S(null),f.success("Student updated successfully!")}catch{f.error("Failed to update student.")}},j=async a=>{if(window.confirm("Are you sure you want to remove this student?"))try{await I.delete(`${$}/batches/students/${a}`,{withCredentials:!0}),h(o.filter(x=>x._id!==a)),f.success("Student removed successfully.")}catch{f.error("Failed to remove student.")}};return v?e.jsx(V,{className:"py-10"}):e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h6",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:["Total Students: ",o.length]}),i&&e.jsx("button",{onClick:()=>A(!u),className:"text-xs font-semibold px-3 py-1 bg-indigo-50 text-indigo-600 rounded-md hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400",children:u?"Cancel":"+ Add Student"})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-100 dark:border-gray-700 rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Student ID"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"DOB"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Phone"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Parent Phone"}),i&&e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:[u&&e.jsxs("tr",{className:"bg-indigo-50/30 dark:bg-indigo-900/10",children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:l.studentId,onChange:a=>y({...l,studentId:a.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"ID (Opt)"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:l.studentName,onChange:a=>y({...l,studentName:a.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Name"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"date",value:l.dob,onChange:a=>y({...l,dob:a.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:l.phoneNumber,onChange:a=>y({...l,phoneNumber:a.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Phone"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:l.parentPhoneNumber,onChange:a=>y({...l,parentPhoneNumber:a.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Parent (Opt)"})}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsx("button",{onClick:m,className:"text-green-600 hover:text-green-800 mr-2",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})})})]}),o.map(a=>e.jsx("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:E===a._id?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:p.studentId,onChange:x=>B({...p,studentId:x.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:p.studentName,onChange:x=>B({...p,studentName:x.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"date",value:p.dob?new Date(p.dob).toISOString().split("T")[0]:"",onChange:x=>B({...p,dob:x.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:p.phoneNumber,onChange:x=>B({...p,phoneNumber:x.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:p.parentPhoneNumber,onChange:x=>B({...p,parentPhoneNumber:x.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsxs("td",{className:"px-4 py-2 text-right",children:[e.jsx("button",{onClick:N,className:"text-green-600 hover:text-green-800 mr-2",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:()=>S(null),className:"text-red-600 hover:text-red-800",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:a.studentId||"-"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:a.studentName}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:a.dob?new Date(a.dob).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:a.phoneNumber}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:a.parentPhoneNumber||"-"}),i&&e.jsxs("td",{className:"px-4 py-2 text-right",children:[e.jsx("button",{onClick:()=>{S(a._id),B(a)},className:"text-gray-400 hover:text-indigo-600 mr-2",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})})}),e.jsx("button",{onClick:()=>j(a._id),className:"text-gray-400 hover:text-red-600",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})},a._id)),!u&&o.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-10 text-center text-sm text-gray-500",children:"No students enrolled in this batch yet."})})]})]})})]})}function ne({isOpen:d,onClose:b,batch:i}){const{user:o}=J(),[h,v]=c.useState([]),[D,u]=c.useState(!1),[A,E]=c.useState(!1),[S,k]=c.useState(new Date().toISOString().split("T")[0]),[l,y]=c.useState({}),[p,B]=c.useState(!1),C=o&&i&&o.fullName===i.instructorName||Y(o,"Instructor"),m=(W(o)||q(o)||U(o)||C)&&!Y(o,"Academic Coordinator");c.useEffect(()=>{d&&i&&(k(new Date().toISOString().split("T")[0]),N())},[d,i]);const N=async()=>{u(!0);try{const s=(await I.get(`${$}/batches/${i._id}/students`,{withCredentials:!0})).data.students;v(s);try{const w=(await I.get(`${$}/batches/${i._id}/attendance?date=${S}`,{withCredentials:!0})).data.attendance[0],t={};w?w.records.forEach(n=>{t[n.studentId]={status:n.status,remarks:n.remarks}}):s.forEach(n=>{t[n._id]={status:"Present",remarks:""}}),y(t)}catch(g){console.error("No existing attendance found or error fetching",g);const w={};s.forEach(t=>{w[t._id]={status:"Present",remarks:""}}),y(w)}}catch(r){console.error("Failed to fetch data:",r),f.error("Failed to load students.")}finally{u(!1)}},j=r=>{if(!i)return!1;const s=new Date(r),g=new Date(i.startDate),w=new Date(i.expectedEndDate);return s.setHours(0,0,0,0),g.setHours(0,0,0,0),w.setHours(0,0,0,0),s>=g&&s<=w},a=(r,s)=>{if(m){if(!j(S)){f.error("Attendance date must be within batch duration.");return}y(g=>({...g,[r]:{...g[r],status:s}}))}},x=async()=>{var r,s;if(m){if(!j(S)){f.error("Cannot mark attendance outside of batch dates.");return}E(!0);try{const g=Object.keys(l).map(w=>({studentId:w,status:l[w].status,remarks:l[w].remarks}));await I.post(`${$}/batches/${i._id}/attendance`,{date:S,records:g},{withCredentials:!0}),f.success("Attendance marked successfully!"),b()}catch(g){console.error("Error marking attendance:",g),f.error(((s=(r=g.response)==null?void 0:r.data)==null?void 0:s.message)||"Failed to mark attendance.")}finally{E(!1)}}};return d?e.jsx(G,{isOpen:d,onClose:b,className:"max-w-4xl p-0 h-[90vh] sm:h-auto sm:max-h-[90vh]",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 sm:p-6 border-b border-gray-100 dark:border-gray-700 shrink-0 pr-12 sm:pr-14",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white",children:m?"Mark Attendance":"View Attendance"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400",children:[i==null?void 0:i.batchName," | ",new Date().toLocaleDateString("en-US",{day:"numeric",month:"short",year:"numeric"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar",children:D?e.jsx(V,{className:"py-20"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Student Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:h.map(r=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-4 text-sm font-medium text-gray-900 dark:text-white",children:[e.jsx("div",{children:r.studentName}),e.jsx("div",{className:"text-xs font-normal text-gray-500 dark:text-gray-400 mt-1",children:r.phoneNumber})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400",children:e.jsx("div",{className:"flex gap-2",children:["Present","Absent","Late","Excused","Holiday"].map(s=>{var g;return e.jsx("button",{onClick:()=>a(r._id,s),disabled:!m,className:`px-3 py-1 rounded-full text-xs font-medium transition-colors border 
                                                            ${((g=l[r._id])==null?void 0:g.status)===s?s==="Present"?"bg-green-100 text-green-800 border-green-200":s==="Absent"?"bg-red-100 text-red-800 border-red-200":s==="Late"?"bg-yellow-100 text-yellow-800 border-yellow-200":s==="Holiday"?"bg-purple-100 text-purple-800 border-purple-200":"bg-blue-100 text-blue-800 border-blue-200":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600"}
                                                            ${m?"":"cursor-default opacity-80"}
                                                        `,children:s},s)})})})]},r._id))})]})}),e.jsxs("div",{className:"md:hidden",children:[e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2 italic",children:"Attendance Legend"}),e.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-2",children:[{l:"P",n:"Present",c:"bg-green-100 text-green-800 border-green-200"},{l:"A",n:"Absent",c:"bg-red-100 text-red-800 border-red-200"},{l:"L",n:"Late",c:"bg-yellow-100 text-yellow-800 border-yellow-200"},{l:"E",n:"Excused",c:"bg-blue-100 text-blue-800 border-blue-200"},{l:"H",n:"Holiday",c:"bg-purple-100 text-purple-800 border-purple-200"}].map(r=>e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:`w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold border ${r.c}`,children:r.l}),e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:r.n})]},r.l))})]}),e.jsx("div",{className:"space-y-4",children:h.map(r=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-900 dark:text-white",children:r.studentName}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-0.5",children:r.phoneNumber})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:["Present","Absent","Late","Excused","Holiday"].map(s=>{var g;return e.jsx("button",{onClick:()=>a(r._id,s),disabled:!m,className:`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold transition-colors border
                                                    ${((g=l[r._id])==null?void 0:g.status)===s?s==="Present"?"bg-green-100 text-green-800 border-green-200":s==="Absent"?"bg-red-100 text-red-800 border-red-200":s==="Late"?"bg-yellow-100 text-yellow-800 border-yellow-200":s==="Holiday"?"bg-purple-100 text-purple-800 border-purple-200":"bg-blue-100 text-blue-800 border-blue-200":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600"}
                                                    ${m?"":"cursor-default opacity-80"}
                                                `,children:s.charAt(0)},s)})})]},r._id))})]})]})}),e.jsxs("div",{className:"mt-auto p-4 sm:p-6 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3 shrink-0",children:[e.jsx(P,{variant:"outline",onClick:b,className:"px-4 py-2",children:"Close"}),m&&e.jsx(P,{variant:"primary",onClick:x,loading:A,className:"px-6 py-2",children:"Save Attendance"})]})]})}):null}function de({isOpen:d,onClose:b,batch:i}){const[o,h]=c.useState(!1),[v,D]=c.useState(new Date().getMonth()+1),[u,A]=c.useState(new Date().getFullYear()),[E,S]=c.useState([]),[k,l]=c.useState([]),y=["January","February","March","April","May","June","July","August","September","October","November","December"],p=new Date().getFullYear(),B=[p-1,p,p+1];c.useEffect(()=>{d&&i&&C()},[d,i,v,u]);const C=async()=>{h(!0);try{const n=(await I.get(`${$}/batches/${i._id}/students`,{withCredentials:!0})).data.students;l(n);const M=await I.get(`${$}/batches/${i._id}/attendance?month=${v}&year=${u}`,{withCredentials:!0});S(M.data.attendance)}catch(t){console.error("Failed to fetch monthly attendance:",t),f.error("Failed to load attendance report.")}finally{h(!1)}},N=((t,n)=>new Date(n,t,0).getDate())(v,u),j=Array.from({length:N},(t,n)=>n+1),a=()=>{const t={},n={},M={present:0,absent:0,late:0,excused:0,holiday:0},L={};return k.forEach(T=>{t[T._id]={},n[T._id]={present:0,absent:0,late:0,excused:0,holiday:0,totalSessions:0}}),E.forEach(T=>{const F=new Date(T.date).getDate();T.records.forEach(O=>{if(t[O.studentId]&&(t[O.studentId][F]=O.status,n[O.studentId])){const H=n[O.studentId],R=O.status;L[F]||(L[F]={present:0,absent:0,late:0,excused:0,holiday:0}),R==="Holiday"?(H.holiday++,M.holiday++,L[F].holiday++):(H.totalSessions++,R==="Present"?(H.present++,M.present++,L[F].present++):R==="Absent"?(H.absent++,M.absent++,L[F].absent++):R==="Late"?(H.late++,M.late++,L[F].late++):R==="Excused"&&(H.excused++,M.excused++,L[F].excused++))}})}),{studentMap:t,statsMap:n,monthlySummary:M,dailyStats:L}},{studentMap:x,statsMap:r,monthlySummary:s,dailyStats:g}=a(),w=t=>{if(!t)return e.jsx("span",{className:"text-gray-200 text-xs",children:"-"});let n="text-gray-500",M=t.charAt(0);switch(t){case"Present":n="bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800";break;case"Absent":n="bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800";break;case"Late":n="bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800";break;case"Excused":n="bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800";break;case"Holiday":n="bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800";break;default:n="bg-gray-50 text-gray-400 border-gray-100 dark:bg-gray-800/50 dark:text-gray-600 dark:border-gray-800";break}return e.jsx("div",{className:`w-6 h-6 flex items-center justify-center rounded-full text-[10px] sm:text-xs font-bold mx-auto border ${n}`,children:M})};return d?e.jsxs(G,{isOpen:d,onClose:b,className:"max-w-6xl p-6 h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 shrink-0 pr-10 sm:pr-12",children:[e.jsxs("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white",children:["Monthly Attendance Report - ",i==null?void 0:i.batchName]}),e.jsxs("div",{className:"flex gap-3 sm:gap-4",children:[e.jsx("select",{value:v,onChange:t=>D(Number(t.target.value)),className:"p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:y.map((t,n)=>e.jsx("option",{value:n+1,children:t},n))}),e.jsx("select",{value:u,onChange:t=>A(Number(t.target.value)),className:"p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:B.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),!o&&e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-600 shrink-0",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3 tracking-widest",children:"Monthly Status Indicators"}),e.jsx("div",{className:"flex flex-wrap gap-x-8 gap-y-3",children:[{l:"P",n:"Present",c:"bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400",count:s.present},{l:"A",n:"Absent",c:"bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-400",count:s.absent},{l:"L",n:"Late",c:"bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400",count:s.late},{l:"E",n:"Excused",c:"bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400",count:s.excused},{l:"H",n:"Holiday",c:"bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400",count:s.holiday}].map(t=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold border shadow-sm ${t.c}`,children:t.l}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-400 dark:text-gray-500 uppercase leading-none mb-1",children:t.n}),e.jsx("span",{className:"text-sm font-bold text-gray-800 dark:text-white leading-none",children:t.count})]})]},t.l))})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg",children:o?e.jsx(V,{className:"h-full"}):e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-50 dark:bg-gray-700 z-20 border-r dark:border-gray-600 min-w-[150px] sm:min-w-[200px]",children:"Student Name"}),j.map(t=>{const n=new Date(u,v-1,t),M=["S","M","T","W","T","F","S"][n.getDay()],L=n.getDay()===0;return e.jsxs("th",{className:`px-1 py-2 text-center text-[10px] font-medium min-w-[32px] border-l dark:border-gray-600 ${L?"text-red-600 bg-red-50 dark:bg-red-900/20":"text-gray-500 dark:text-gray-300"}`,children:[e.jsx("div",{className:"mb-0.5",children:M}),e.jsx("div",{className:"text-[11px]",children:t})]},t)}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700 sticky right-0 z-20 border-l dark:border-gray-600",children:"Total"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700 sticky right-0 z-20 border-l dark:border-gray-600",children:"%"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:k.map(t=>{const n=r[t._id]||{present:0,totalSessions:0},M=n.totalSessions>0?Math.round(n.present/n.totalSessions*100):0;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white sticky left-0 bg-white dark:bg-gray-800 z-10 border-r dark:border-gray-600 max-w-[150px] sm:max-w-none truncate",children:t.studentName}),j.map(L=>{var F;const K=new Date(u,v-1,L).getDay()===0;return e.jsx("td",{className:`px-1 py-1 text-center border-l border-gray-100 dark:border-gray-700 ${K?"bg-red-50/50 dark:bg-red-900/5":""}`,children:w((F=x[t._id])==null?void 0:F[L])},L)}),e.jsxs("td",{className:"px-4 py-2 text-center text-sm text-gray-900 dark:text-white sticky right-0 bg-white dark:bg-gray-800 z-10 border-l dark:border-gray-600 font-semibold",children:[e.jsx("span",{className:"text-green-600",children:n.present})," / ",n.totalSessions]}),e.jsx("td",{className:"px-4 py-2 text-center text-sm sticky right-0 bg-white dark:bg-gray-800 z-10 border-l dark:border-gray-600 font-bold",children:e.jsxs("span",{className:M>=75?"text-green-600":M>=50?"text-yellow-600":"text-red-600",children:[M,"%"]})})]},t._id)})}),e.jsxs("tfoot",{className:"bg-gray-50 dark:bg-gray-700/30 sticky bottom-0 z-10",children:[e.jsxs("tr",{className:"border-t-2 border-gray-200 dark:border-gray-600",children:[e.jsx("td",{className:"px-4 py-2 font-bold text-[10px] uppercase tracking-wider text-gray-500 sticky left-0 bg-gray-50 dark:bg-gray-700 z-10 border-r dark:border-gray-600",children:"Total Presents"}),j.map(t=>{var n;return e.jsx("td",{className:"px-1 py-1 text-center font-bold text-[11px] border-l border-gray-100 dark:border-gray-700 text-green-600",children:((n=g[t])==null?void 0:n.present)||0},t)}),e.jsx("td",{colSpan:2,className:"bg-gray-50 dark:bg-gray-700"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-bold text-[10px] uppercase tracking-wider text-gray-500 sticky left-0 bg-gray-50 dark:bg-gray-700 z-10 border-r dark:border-gray-600",children:"Total Absents"}),j.map(t=>{var n;return e.jsx("td",{className:"px-1 py-1 text-center font-bold text-[11px] border-l border-gray-100 dark:border-gray-700 text-red-600",children:((n=g[t])==null?void 0:n.absent)||0},t)}),e.jsx("td",{colSpan:2,className:"bg-gray-50 dark:bg-gray-700"})]})]})]})}),e.jsx("div",{className:"mt-6 flex justify-end shrink-0",children:e.jsx(P,{variant:"outline",onClick:b,className:"px-6 py-2.5",children:"Close"})})]}):null}function le({batch:d,onUpdate:b,onDelete:i}){const{user:o}=J(),[h,v]=c.useState(!1),[D,u]=c.useState(!1),[A,E]=c.useState({...d}),[S,k]=c.useState(!1),[l,y]=c.useState(!1),p=o&&d&&o.fullName===d.instructorName||Y(o,"Instructor"),B=W(o)||q(o)||U(o)||p,C=W(o)||q(o)||U(o),m=()=>v(!h),N=async r=>{if(r.stopPropagation(),window.confirm("Are you sure you want to delete this batch and all its students?"))try{await I.delete(`${$}/batches/${d._id}`,{withCredentials:!0}),f.success("Batch deleted successfully."),i(d._id)}catch{f.error("Failed to delete batch.")}},j=r=>{r.stopPropagation(),u(!0)},a=async r=>{r.preventDefault();try{const s=await I.put(`${$}/batches/${d._id}`,A,{withCredentials:!0});f.success("Batch updated successfully."),b(s.data.batch),u(!1)}catch{f.error("Failed to update batch.")}},x=r=>{const{name:s,value:g}=r.target;if(s.includes("batchTime.")){const w=s.split(".")[1];E(t=>({...t,batchTime:{...t.batchTime,[w]:g}}))}else E(w=>({...w,[s]:g}))};return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",onClick:m,children:[e.jsxs("div",{className:"flex items-start sm:items-center space-x-4 w-full sm:w-auto",children:[e.jsx("div",{className:`transform transition-transform mt-1 sm:mt-0 ${h?"rotate-90":""}`,children:e.jsx("svg",{className:"h-5 w-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:d.batchName}),e.jsxs("div",{className:"flex flex-wrap gap-y-2 gap-x-6 text-sm text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Subject:"}),e.jsx("span",{children:d.subject})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Duration:"}),e.jsxs("span",{children:[new Date(d.startDate).toLocaleDateString()," - ",new Date(d.expectedEndDate).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Timing:"}),e.jsxs("span",{children:[d.batchTime.from," - ",d.batchTime.to]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Mode:"}),e.jsx("span",{className:`uppercase font-bold text-xs px-2 py-0.5 rounded ${d.mode==="online"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:d.mode})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Instructor:"}),e.jsx("span",{children:d.instructorName})]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-4 sm:mt-0 w-full sm:w-auto",children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),k(!0)},className:"px-3 py-1 text-xs font-medium bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:bg-indigo-900/50 transition-colors",children:B?"Mark Attendance":"View Attendance"}),e.jsx("button",{onClick:r=>{r.stopPropagation(),y(!0)},className:"px-3 py-1 text-xs font-medium bg-green-50 text-green-600 rounded-full hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:hover:bg-green-900/50 transition-colors",children:"Monthly Report"}),C&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:j,className:"p-2 text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400",title:"Edit Batch",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:N,className:"p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400",title:"Delete Batch",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})]}),h&&e.jsxs("div",{className:"p-6 border-t border-gray-100 dark:border-gray-700",children:[D?e.jsx("form",{onSubmit:a,className:"mb-8 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 uppercase",children:"Batch Name"}),e.jsx("input",{type:"text",name:"batchName",value:A.batchName,onChange:x,className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 uppercase",children:"Instructor Assigned"}),e.jsx("input",{type:"text",name:"instructorName",value:A.instructorName,onChange:x,className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 uppercase",children:"Mode"}),e.jsxs("select",{name:"mode",value:A.mode,onChange:x,className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"online",children:"Online"}),e.jsx("option",{value:"offline",children:"Offline"})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"submit",className:"px-3 py-1 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700",children:"Save"}),e.jsx("button",{type:"button",onClick:()=>u(!1),className:"px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300",children:"Cancel"})]})]})}):null,e.jsxs("div",{className:"mt-6",children:[e.jsxs("h5",{className:"text-md font-semibold text-gray-800 dark:text-white mb-4 flex items-center",children:[e.jsx(ae,{className:"h-5 w-5 mr-2 text-gray-400"}),"Enrolled Students"]}),e.jsx(se,{batchId:d._id})]})]}),e.jsx(ne,{isOpen:S,onClose:()=>k(!1),batch:d}),e.jsx(de,{isOpen:l,onClose:()=>y(!1),batch:d})]})}function oe({isOpen:d,onClose:b,onCreated:i}){const[o,h]=c.useState({batchName:"",instructorName:"",mode:"online",subject:"",startDate:"",expectedEndDate:"",batchTime:{from:"",to:""}}),[v,D]=c.useState(!1),[u,A]=c.useState([]),[E,S]=c.useState("");c.useEffect(()=>{d&&(async()=>{try{const m=await I.get(`${$}/users/dropdown?roles=Instructor`,{withCredentials:!0}),N=["Instructor"],a=m.data.users.filter(x=>x.roles&&x.roles.some(r=>N.includes(r))).map(x=>({value:x._id,label:x.fullName}));A(a)}catch(m){console.error("Failed to fetch instructors:",m),f.error("Failed to load instructors")}})()},[d]);const k=C=>{const{name:m,value:N}=C.target;if(m.includes("batchTime.")){const j=m.split(".")[1];h(a=>({...a,batchTime:{...a.batchTime,[j]:N}}))}else h(j=>({...j,[m]:N}))},l=C=>{S(C);const m=u.find(N=>N.value===C);m&&h(N=>({...N,instructorName:m.label}))},y=C=>{h(m=>({...m,mode:C}))},p=async C=>{var m,N;C.preventDefault(),D(!0);try{const j=await I.post(`${$}/batches`,o,{withCredentials:!0});f.success("Batch created successfully!"),i(j.data.batch),b(),h({batchName:"",instructorName:"",mode:"online",subject:"",startDate:"",expectedEndDate:"",batchTime:{from:"",to:""}}),S("")}catch(j){console.error("Error creating batch:",j),f.error(((N=(m=j.response)==null?void 0:m.data)==null?void 0:N.message)||"Failed to create batch.")}finally{D(!1)}},B=[{value:"online",label:"Online"},{value:"offline",label:"Offline"}];return e.jsxs(G,{isOpen:d,onClose:b,className:"max-w-2xl p-6 lg:p-10",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-6",children:"Create New Batch"}),e.jsxs("form",{onSubmit:p,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx(_,{htmlFor:"batchName",children:"Batch Name"}),e.jsx(z,{type:"text",id:"batchName",name:"batchName",required:!0,value:o.batchName,onChange:k,placeholder:"e.g. Batchname Jan 2026"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"instructorName",children:"Instructor Assigned"}),e.jsx(Q,{options:u,value:E,onChange:l,placeholder:"Select Instructor",disabled:u.length===0})]}),e.jsxs("div",{children:[e.jsx(_,{children:"Mode"}),e.jsx(Q,{options:B,value:o.mode,onChange:y})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(_,{htmlFor:"subject",children:"Subject"}),e.jsx(z,{type:"text",id:"subject",name:"subject",required:!0,value:o.subject,onChange:k})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"startDate",children:"Start Date"}),e.jsx(z,{type:"date",id:"startDate",name:"startDate",required:!0,value:o.startDate,onChange:k})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"expectedEndDate",children:"Expected End Date"}),e.jsx(z,{type:"date",id:"expectedEndDate",name:"expectedEndDate",required:!0,value:o.expectedEndDate,onChange:k})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"batchTime.from",children:"Time From"}),e.jsx(z,{type:"time",id:"batchTime.from",name:"batchTime.from",required:!0,value:o.batchTime.from,onChange:k})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"batchTime.to",children:"Time To"}),e.jsx(z,{type:"time",id:"batchTime.to",name:"batchTime.to",required:!0,value:o.batchTime.to,onChange:k})]})]}),e.jsxs("div",{className:"mt-8 flex flex-col-reverse sm:flex-row sm:justify-end gap-3",children:[e.jsx(P,{type:"button",variant:"outline",onClick:b,className:"w-full sm:w-auto mt-2 sm:mt-0",children:"Cancel"}),e.jsx(P,{type:"submit",variant:"primary",loading:v,className:"w-full sm:w-auto",children:"Create Batch"})]})]})]})}function xe(){const{user:d}=c.useContext(X),[b,i]=c.useState([]),[o,h]=c.useState(!0),[v,D]=c.useState(!1),u=W(d)||q(d)||U(d);c.useEffect(()=>{A()},[]);const A=async()=>{try{h(!0);const l=await I.get(`${$}/batches`,{withCredentials:!0});i(l.data.batches)}catch(l){console.error("Error fetching batches:",l),f.error("Failed to load batches.")}finally{h(!1)}},E=l=>{i([l,...b]),D(!1)},S=l=>{i(b.map(y=>y._id===l._id?l:y))},k=l=>{i(b.filter(y=>y._id!==l))};return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx(Z,{title:"Batch Management | DreamCRM",description:"Manage students in structured batches"}),e.jsx(ee,{pageTitle:"Batch Management"}),e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-white",children:"Structured Batches"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Create and manage student batches for your brand"})]}),u&&e.jsx(P,{variant:"primary",onClick:()=>D(!0),className:"w-full sm:w-auto",children:"Create New Batch"})]}),o?e.jsx(V,{}):b.length>0?e.jsx("div",{className:"space-y-4",children:b.map(l=>e.jsx(le,{batch:l,onUpdate:S,onDelete:k},l._id))}):e.jsx(te,{children:e.jsxs("div",{className:"text-center py-10",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"No batches found for this brand."}),u&&e.jsx(P,{variant:"outline",onClick:()=>D(!0),children:"Start by creating your first batch"})]})}),v&&e.jsx(oe,{isOpen:v,onClose:()=>D(!1),onCreated:E}),e.jsx(re,{position:"top-center",autoClose:3e3,className:"!z-[999999]",style:{zIndex:999999}})]})}export{xe as default};
