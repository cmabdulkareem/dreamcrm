import{r as s,j as e,I as x,n as Le,A as Ve,b as Ge,u as Ue,c as T,d as W,y as N,P as Ze,G as Je,C as Ke,z as o,K as V,W as ye,X as Se,Y as He,Z as Xe,_ as Ye,$ as Qe,B as Q,o as ea}from"./index-BRRNp47y.js";import{D as ke}from"./date-picker-DxGeXKuS.js";import{S as Pe}from"./SearchableCourseSelect-DUB_OBEY.js";import{S as aa}from"./chevron-down-2NhGbJfV.js";import"./calender-line-CMLkAvQj.js";const ta=s.forwardRef(({leads:m=[],value:h,onChange:C,placeholder:ee="Search and select a converted lead...",error:_,disabled:n=!1,loading:G=!1},P)=>{const[L,j]=s.useState([]),[E,p]=s.useState(!1),[c,b]=s.useState(""),w=s.useRef(null),I=s.useRef(null);s.useEffect(()=>{if(!c)j(m);else{const r=c.toLowerCase(),i=m.filter(u=>{const U=(u.fullName||"").toLowerCase(),y=(u.email||"").toLowerCase(),Z=(u.phone1||"").toLowerCase();return U.includes(r)||y.includes(r)||Z.includes(r)});j(i)}},[c,m]),s.useEffect(()=>{const r=i=>{w.current&&!w.current.contains(i.target)&&p(!1)};return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]);const F=s.useCallback(r=>{C(r._id),p(!1);const i=r.fullName||"Unnamed Lead",u=r.email?` (${r.email})`:"";b(`${i}${u}`)},[C]),B=s.useCallback(r=>{const i=r.target.value;b(i),i&&p(!0)},[]),$=s.useCallback(()=>{n||p(!0)},[n]),f=s.useCallback(()=>{var r;b(""),C(""),(r=I.current)==null||r.focus()},[C]);s.useEffect(()=>{if(h&&!c){const r=m.find(i=>i._id===h);if(r){const i=r.fullName||"Unnamed Lead",u=r.email?` (${r.email})`:"";b(`${i}${u}`)}}},[h,m,c]);const O=()=>e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})});return e.jsxs("div",{className:"relative",ref:w,children:[e.jsxs("div",{className:"relative",children:[e.jsx(x,{ref:I,type:"text",value:c,onChange:B,onFocus:$,placeholder:ee,error:_,disabled:n,className:"pr-20"}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:G?e.jsx(Le,{className:"",size:"h-4 w-4"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center pr-2 border-r border-gray-300 dark:border-gray-700 mr-2",children:e.jsx(O,{})}),e.jsx(aa,{className:`h-4 w-4 text-gray-400 transition-transform ${E?"rotate-180":""}`})]})}),c&&!n&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-12 flex items-center pr-2 text-gray-400 hover:text-gray-600",onClick:f,children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),E&&!n&&e.jsx("div",{className:"absolute z-10 mt-1 w-full rounded-md bg-white shadow-lg dark:bg-gray-800",children:e.jsxs("div",{className:"max-h-60 overflow-auto py-1",children:[L.length===0?e.jsx("div",{className:"px-4 py-2 text-gray-500 dark:text-gray-400",children:c?"No leads found":"No converted leads available"}):L.map(r=>e.jsxs("button",{type:"button",className:"block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700",onClick:()=>F(r),children:[e.jsx("div",{className:"font-medium",children:r.fullName||"Unnamed Lead"}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[r.email||"No email"," • ",r.phone1||"No phone"]})]},r._id)),e.jsx("button",{type:"button",className:"block w-full px-4 py-2 text-left text-sm font-semibold text-brand-600 hover:bg-brand-50 bg-brand-50/30 border-t border-gray-100 dark:bg-brand-900/10 dark:hover:bg-brand-900/20 dark:border-gray-700",onClick:()=>{C("no_lead"),p(!1),b("--- Add Without Lead ---")},children:"+ Add Without Lead"})]})})]})});function oa(){const{user:m,selectedBrand:h}=s.useContext(Ve),C=Ge(),{addNotification:ee,areToastsEnabled:_}=Ue(),[n,G]=s.useState(""),[P,L]=s.useState(""),[j,E]=s.useState(""),[p,c]=s.useState(""),[b,w]=s.useState(""),[I,F]=s.useState(""),[B,$]=s.useState(""),[f,O]=s.useState("Kasaragod"),[r,i]=s.useState(""),[u,U]=s.useState(""),[y,Z]=s.useState(""),[ae,te]=s.useState(null),[se,re]=s.useState(""),[ne,J]=s.useState(""),[le,K]=s.useState(""),[S,H]=s.useState(""),[g,z]=s.useState([]),[q,fe]=s.useState(""),[k,pe]=s.useState(new Date().toISOString().split("T")[0]),[R,de]=s.useState(""),[xe,ge]=s.useState(!1),[A,ve]=s.useState([]),[oe,Ee]=s.useState([]),[Ae,De]=s.useState([]),[v,ie]=s.useState((h==null?void 0:h._id)||""),[je,be]=s.useState(!0),[ce,Ne]=s.useState(!1),[l,Ce]=s.useState({}),X=s.useRef(null);s.useEffect(()=>{Ie(),_e(),Fe()},[]),s.useEffect(()=>{h!=null&&h._id&&!v&&ie(h._id)},[h,v]);const _e=s.useCallback(async()=>{try{const t=await T.get(`${W}/courses/all`,{withCredentials:!0});Ee(t.data.courses)}catch(t){console.error("Error fetching courses:",t)}},[]),Ie=s.useCallback(async()=>{try{be(!0);const a=(await T.get(`${W}/customers/converted`,{withCredentials:!0})).data.customers.filter(d=>d.leadStatus==="converted");ve(a)}catch(t){console.error("Error fetching converted leads:",t),t.response&&t.response.status===401?N.error("Please login to view converted leads"):(ve([{_id:"1",fullName:"John Doe",email:"john@example.com",phone1:"+1 234 567 8900",leadStatus:"converted"},{_id:"2",fullName:"Jane Smith",email:"jane@example.com",phone1:"+1 234 567 8901",leadStatus:"converted"}]),N.info("Using demo data for demonstration"))}finally{be(!1)}},[]),Fe=s.useCallback(async()=>{try{const t=await T.get(`${W}/brands`,{withCredentials:!0});De(t.data.brands||[])}catch(t){console.error("Error fetching brands:",t),N.error("Failed to fetch brands")}},[]);s.useMemo(()=>A.map(t=>({value:t._id,label:`${t.fullName} (${t.email})`})),[A]);const D=s.useCallback(()=>{let t=0;if(S){const a=oe.find(d=>d._id===S);a&&(t+=a.normalFee||0)}return g.forEach(a=>{const d=oe.find(he=>he._id===a);d&&(t+=d.normalFee||0)}),t},[S,g,oe]),M=s.useCallback(()=>{const t=D(),a=parseFloat(q)||0;return t*a/100},[D,q]),ue=s.useCallback(()=>{const t=D(),a=M();return t-a},[D,M]),$e=()=>{z([...g,""])},Oe=t=>{const a=[...g];a.splice(t,1),z(a)},ze=(t,a)=>{const d=[...g];d[t]=a,z(d)},Be=s.useCallback(t=>{if(G(t),t&&t!=="no_lead"){const a=A.find(d=>d._id===t);a&&(L(a.fullName||""),E(a.email||""),c(a.phone1||""),w(a.phone2||""),F(a.gender||""),$(a.dob?new Date(a.dob).toISOString().split("T")[0]:""),O(a.place||""),i(a.otherPlace||""),J(a.status||""),K(a.education||""),H(""),z([]))}else L(""),E(""),c(""),w(""),F(""),$(""),O(""),i(""),J(""),K(""),H(""),z([])},[A]),qe=(t,a)=>{pe(a)};s.useEffect(()=>{(async()=>{if(v&&k)try{const a=await T.get(`${W}/students/get-next-id?brandId=${v}&enrollmentDate=${k}`,{withCredentials:!0});de(a.data.nextStudentId)}catch(a){console.error("Error fetching next student ID:",a)}else de("")})()},[v,k]);const Y=s.useCallback(t=>{const a=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t);return ge(!a),a},[]),Re=s.useCallback(t=>{const a=t.target.value;E(a),Y(a)},[Y]),Me=s.useCallback(t=>{const a=t.target.files[0];if(!a)return;if(!a.type.startsWith("image/")){N.error("Please select an image file");return}if(a.size>5*1024*1024){N.error("File size exceeds 5MB limit");return}te(a);const d=new FileReader;d.onloadend=()=>{re(d.result)},d.readAsDataURL(a)},[]),Te=()=>{var t;(t=X.current)==null||t.click()},me=s.useCallback(()=>{G(""),L(""),E(""),c(""),w(""),F(""),$(""),O(""),i(""),U(""),Z(""),te(null),re(""),J(""),K(""),H(""),z([]),fe(""),pe(""),de(""),ie(""),ge(!1),Ce({})},[]),we=s.useCallback(()=>{const t={};if(!n)t.selectedLead="Please select a converted lead or 'Add without lead'";else if(n!=="no_lead"){const a=A.find(d=>d._id===n);a&&a.leadStatus!=="converted"&&(t.selectedLead="Selected lead is not in converted status")}return P.trim()||(t.fullName="Full Name is required"),v||(t.selectedBrand="Please select a brand"),j.trim()?Y(j)||(t.email="Please enter a valid email address"):t.email="Email is required",p.trim()||(t.phone1="Phone is required"),f?f==="Other"&&!r.trim()&&(t.otherPlace="Please specify the place"):t.place="Place is required",u.trim()||(t.address="Address is required"),y.trim()?/^\d{12}$/.test(y)||(t.aadharCardNumber="Aadhar Card Number must be 12 digits"):t.aadharCardNumber="Aadhar Card Number is required",S||(t.coursePreference="Primary course is required. Please select a course from the course management database."),g.forEach((a,d)=>{a||(t[`additionalCourse${d}`]=`Additional course ${d+1} is required`)}),k||(t.enrollmentDate="Enrollment date is required"),R.trim()||(t.studentId="Student ID is required"),Ce(t),Object.keys(t).length===0},[n,P,v,j,p,f,r,u,y,S,g,k,R,A,Y]),We=s.useCallback(async t=>{if(t.preventDefault(),!we()){_()&&N.error("Please fill in all required fields");return}try{Ne(!0);const a=new FormData;a.append("studentId",R),a.append("fullName",P),a.append("email",j),a.append("phone1",p),a.append("phone2",b),a.append("gender",I),a.append("dob",B),a.append("place",f==="Other"?r:f),a.append("otherPlace",f==="Other"?r:""),a.append("address",u),a.append("aadharCardNumber",y),a.append("status",ne),a.append("education",le),a.append("coursePreference",S),a.append("additionalCourses",JSON.stringify(g.filter(he=>he))),a.append("totalCourseValue",D()),a.append("discountPercentage",q||0),a.append("discountAmount",M()),a.append("finalAmount",ue()),a.append("enrollmentDate",k),a.append("leadId",n==="no_lead"?"":n),a.append("brandId",v),ae&&a.append("photo",ae),(await T.post(`${W}/students/create`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"}})).status===201&&(_()&&N.success("Student created successfully!"),ee({type:"student_created",userName:(m==null?void 0:m.fullName)||"Someone",avatar:(m==null?void 0:m.avatar)||null,action:"created student",entityName:P,module:"Student Management"}),me(),C("/manage-students"))}catch(a){console.error("Error creating student:",a),_()&&(a.response&&a.response.data&&a.response.data.message?N.error(a.response.data.message):N.error("Failed to create student. Please try again."))}finally{Ne(!1)}},[we,R,P,j,p,b,I,B,f,r,u,y,ne,le,S,g,D,q,M,ue,k,n,v,ae,me,C,_]);return e.jsxs("div",{children:[e.jsx(Ze,{title:"New Student | DreamCRM",description:"Add new student here"}),e.jsx(Je,{pageTitle:"New Student"}),e.jsxs("form",{onSubmit:We,children:[e.jsx("div",{className:"grid grid-cols-1 gap-6",children:e.jsx("div",{className:"space-y-6",children:e.jsx(Ke,{title:"Student Information",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Select Converted Lead *"}),je?e.jsxs("div",{className:"flex items-center justify-center h-10 bg-gray-100 dark:bg-gray-800 rounded-lg",children:[e.jsx(Le,{className:"",size:"h-5 w-5"}),e.jsx("span",{className:"ml-2 text-gray-500 dark:text-gray-400",children:"Loading converted leads..."})]}):e.jsx(ta,{leads:A,value:n,onChange:Be,placeholder:"Search and select a converted lead",error:!!l.selectedLead,disabled:je})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{htmlFor:"firstName",children:"Full Name *"}),e.jsx(x,{type:"text",id:"firstName",value:P,onChange:t=>L(t.target.value),error:!!l.fullName,hint:l.fullName,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{htmlFor:"brand",children:"Brand *"}),e.jsx(V,{options:Ae.map(t=>({value:t._id,label:`${t.name} (${t.code})`})),value:v,placeholder:"Select Brand",onChange:ie,error:!!l.selectedBrand})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Email *"}),e.jsx(x,{type:"email",value:j,error:xe||!!l.email,onChange:Re,placeholder:"Enter your email",hint:l.email||(xe?"This is an invalid email address.":""),disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Student Photo"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"file",ref:X,onChange:Me,accept:"image/*",className:"hidden"}),e.jsx("button",{type:"button",onClick:Te,className:"w-20 h-20 overflow-hidden border-2 border-dashed border-gray-300 rounded-full cursor-pointer hover:border-brand-500 transition-colors flex items-center justify-center",children:se?e.jsx("img",{src:se,alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("svg",{className:"w-8 h-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),se&&e.jsx("button",{type:"button",onClick:()=>{te(null),re(""),X.current&&(X.current.value="")},className:"text-sm text-red-500 hover:text-red-700",children:"Remove"})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Phone *"}),e.jsx(ye,{selectPosition:"end",countries:Se,placeholder:"+91 98765 43210",value:p,onChange:c,error:!!l.phone1,hint:l.phone1,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Phone (optional)"}),e.jsx(ye,{selectPosition:"end",countries:Se,placeholder:"+91 98765 43210",value:b,onChange:w,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Gender"}),e.jsx(V,{options:He,value:I,placeholder:"Select Gender",onChange:F,disabled:!!n&&n!=="no_lead"})]}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(ke,{id:"dob",label:"Date of Birth",value:B,onChange:(t,a)=>$(a),disabled:!!n&&n!=="no_lead"})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Place *"}),e.jsx(V,{options:Xe,value:f,placeholder:"Select Place",onChange:O,error:!!l.place,hint:l.place})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{htmlFor:"otherPlace",children:"Specify other *"}),e.jsx(x,{type:"text",id:"otherPlace",value:r,onChange:t=>i(t.target.value),error:f==="Other"&&!r.trim()&&!!l.otherPlace,hint:f==="Other"&&!r.trim()?l.otherPlace:""})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{htmlFor:"address",children:"Address *"}),e.jsx(x,{type:"text",id:"address",value:u,onChange:t=>U(t.target.value),error:!!l.address,hint:l.address,placeholder:"Enter full address"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{htmlFor:"aadharCardNumber",children:"Aadhar Card Number *"}),e.jsx(x,{type:"text",id:"aadharCardNumber",value:y,onChange:t=>Z(t.target.value.replace(/\D/g,"")),error:!!l.aadharCardNumber,hint:l.aadharCardNumber,placeholder:"Enter 12-digit Aadhar number",maxLength:"12"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Current Status"}),e.jsx(V,{options:Ye,value:ne,placeholder:"Select Status",onChange:J,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(o,{children:"Education"}),e.jsx(V,{options:Qe,value:le,placeholder:"Select Education",onChange:K,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/2",children:[e.jsx(o,{children:"Primary Course *"}),e.jsx(Pe,{value:S,onChange:H,placeholder:"Search and select a course...",error:!!l.coursePreference})]})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(o,{children:"Additional Courses *"}),e.jsx(Q,{type:"button",variant:"outline",size:"sm",onClick:$e,children:"Add Course"})]}),g.map((t,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(Pe,{value:t,onChange:d=>ze(a,d),placeholder:"Search and select an additional course...",error:!!l[`additionalCourse${a}`],hint:l[`additionalCourse${a}`]})}),e.jsx(Q,{type:"button",variant:"outline",size:"sm",onClick:()=>Oe(a),children:"Remove"})]},a))]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Total Course Value (₹)"}),e.jsx(x,{type:"text",value:D(),readOnly:!0,className:"bg-gray-100 dark:bg-gray-800"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Discount Percentage (%)"}),e.jsx(x,{type:"number",value:q,onChange:t=>fe(t.target.value),placeholder:"0",min:"0",max:"100"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Discount Amount (₹)"}),e.jsx(x,{type:"text",value:M(),readOnly:!0,className:"bg-gray-100 dark:bg-gray-800"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Final Amount (₹)"}),e.jsx(x,{type:"text",value:ue(),readOnly:!0,className:"bg-gray-100 dark:bg-gray-800"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"w-full md:w-1/2",children:e.jsx(ke,{id:"enrollmentDate",label:"Enrollment Date",placeholder:"Select a date",value:k,onChange:qe,error:!!l.enrollmentDate,hint:l.enrollmentDate})}),e.jsxs("div",{className:"w-full md:w-1/2",children:[e.jsx(o,{htmlFor:"studentId",children:"Student ID (Auto-generated)"}),e.jsx(x,{type:"text",id:"studentId",value:R,readOnly:!0,placeholder:"Select Brand & Date",className:"bg-gray-100 dark:bg-gray-700 font-mono",error:!!l.studentId,hint:l.studentId})]})]})]})})})}),e.jsxs("div",{className:"flex gap-4 justify-end mt-6",children:[e.jsx(Q,{type:"button",onClick:me,variant:"outline",disabled:ce,children:"Clear"}),e.jsx(Q,{variant:"primary",type:"submit",disabled:ce,children:ce?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):"Save Student"})]})]}),e.jsx(ea,{position:"top-center",className:"!z-[999999]",style:{zIndex:999999}})]})}export{oa as default};
