import{r as s,j as e,I as x,m as De,A as Ke,a as Xe,u as Ye,b as J,c as H,y as w,_ as Pe,P as Qe,E as ea,C as aa,x as d,H as z,X as Le,Y as Ee,Z as ta,$ as sa,a0 as ra,B as le,n as na}from"./index-BNEGGE57.js";import{D as Fe}from"./date-picker-BeppTpDh.js";import{S as Ae}from"./SearchableCourseSelect-05YrRIZR.js";import{S as la}from"./chevron-down-BH7m1aFk.js";import"./index-B_JH6AFf.js";import"./calender-line-DQbsZUHO.js";const oa=s.forwardRef(({leads:m=[],value:h,onChange:y,placeholder:oe="Search and select a converted lead...",error:_,disabled:n=!1,loading:K=!1},L)=>{const[E,b]=s.useState([]),[F,p]=s.useState(!1),[u,C]=s.useState(""),S=s.useRef(null),I=s.useRef(null);s.useEffect(()=>{if(!u)b(m);else{const r=u.toLowerCase(),i=m.filter(c=>{const X=(c.fullName||"").toLowerCase(),k=(c.email||"").toLowerCase(),Y=(c.phone1||"").toLowerCase(),T=(c.place||"").toLowerCase(),M=(c.otherPlace||"").toLowerCase();return X.includes(r)||k.includes(r)||Y.includes(r)||T.includes(r)||M.includes(r)});b(i)}},[u,m]),s.useEffect(()=>{const r=i=>{S.current&&!S.current.contains(i.target)&&p(!1)};return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]);const $=s.useCallback(r=>{y(r._id),p(!1);const i=r.fullName||"Unnamed Lead",c=r.email?` (${r.email})`:"";C(`${i}${c}`)},[y]),R=s.useCallback(r=>{const i=r.target.value;C(i),i&&p(!0)},[]),O=s.useCallback(()=>{n||p(!0)},[n]),g=s.useCallback(()=>{var r;C(""),y(""),(r=I.current)==null||r.focus()},[y]);s.useEffect(()=>{if(h&&!u){const r=m.find(i=>i._id===h);if(r){const i=r.fullName||"Unnamed Lead",c=r.email?` (${r.email})`:"";C(`${i}${c}`)}}},[h,m,u]);const A=()=>e.jsx("svg",{className:"h-4 w-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})});return e.jsxs("div",{className:"relative",ref:S,children:[e.jsxs("div",{className:"relative",children:[e.jsx(x,{ref:I,type:"text",value:u,onChange:R,onFocus:O,placeholder:oe,error:_,disabled:n,className:"pr-20"}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:K?e.jsx(De,{className:"",size:"h-4 w-4"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center pr-2 border-r border-gray-300 dark:border-gray-700 mr-2",children:e.jsx(A,{})}),e.jsx(la,{className:`h-4 w-4 text-gray-400 transition-transform ${F?"rotate-180":""}`})]})}),u&&!n&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-12 flex items-center pr-2 text-gray-400 hover:text-gray-600",onClick:g,children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),F&&!n&&e.jsx("div",{className:"absolute z-10 mt-1 w-full rounded-md bg-white shadow-lg dark:bg-gray-800",children:e.jsxs("div",{className:"max-h-60 overflow-auto py-1",children:[E.length===0?e.jsx("div",{className:"px-4 py-2 text-gray-500 dark:text-gray-400",children:u?"No leads found":"No converted leads available"}):E.map(r=>e.jsxs("button",{type:"button",className:"block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700",onClick:()=>$(r),children:[e.jsx("div",{className:"font-medium",children:r.fullName||"Unnamed Lead"}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[r.email||"No email"," • ",r.phone1||"No phone"," ",r.place&&e.jsxs("span",{className:"ml-1 text-brand-600 font-medium",children:["• ",r.place==="Other"?r.otherPlace:r.place]})]})]},r._id)),e.jsx("button",{type:"button",className:"block w-full px-4 py-2 text-left text-sm font-semibold text-brand-600 hover:bg-brand-50 bg-brand-50/30 border-t border-gray-100 dark:bg-brand-900/10 dark:hover:bg-brand-900/20 dark:border-gray-700",onClick:()=>{y("no_lead"),p(!1),C("--- Add Without Lead ---")},children:"+ Add Without Lead"})]})})]})});function pa(){const{user:m,selectedBrand:h}=s.useContext(Ke),y=Xe(),{addNotification:oe,areToastsEnabled:_}=Ye(),[n,K]=s.useState(""),[L,E]=s.useState(""),[b,F]=s.useState(""),[p,u]=s.useState(""),[C,S]=s.useState(""),[I,$]=s.useState(""),[R,O]=s.useState(""),[g,A]=s.useState("Kasaragod"),[r,i]=s.useState(""),[c,X]=s.useState(""),[k,Y]=s.useState(""),[T,M]=s.useState(null),[de,ie]=s.useState(""),[ce,Q]=s.useState(""),[ue,ee]=s.useState(""),[N,ae]=s.useState(""),[f,B]=s.useState([]),[U,te]=s.useState(""),[V,W]=s.useState(""),[P,ge]=s.useState(new Date().toISOString().split("T")[0]),[G,me]=s.useState(""),[q,ve]=s.useState("normal"),[je,be]=s.useState(!1),[D,Ce]=s.useState([]),[se,_e]=s.useState([]),[Ie,$e]=s.useState([]),[v,he]=s.useState((h==null?void 0:h._id)||""),[Ne,we]=s.useState(!0),[pe,ye]=s.useState(!1),[o,Se]=s.useState({}),re=s.useRef(null);s.useEffect(()=>{Be(),Oe(),qe()},[]),s.useEffect(()=>{h!=null&&h._id&&!v&&he(h._id)},[h,v]);const Oe=s.useCallback(async()=>{try{const t=await J.get(`${H}/courses/all`,{withCredentials:!0});_e(t.data.courses)}catch(t){console.error("Error fetching courses:",t)}},[]),Be=s.useCallback(async()=>{try{we(!0);const a=(await J.get(`${H}/customers/converted`,{withCredentials:!0})).data.customers.filter(l=>l.leadStatus==="converted");Ce(a)}catch(t){console.error("Error fetching converted leads:",t),t.response&&t.response.status===401?w.error("Please login to view converted leads"):(Ce([{_id:"1",fullName:"John Doe",email:"john@example.com",phone1:"+1 234 567 8900",leadStatus:"converted"},{_id:"2",fullName:"Jane Smith",email:"jane@example.com",phone1:"+1 234 567 8901",leadStatus:"converted"}]),w.info("Using demo data for demonstration"))}finally{we(!1)}},[]),qe=s.useCallback(async()=>{try{const t=await J.get(`${H}/brands`,{withCredentials:!0});$e(t.data.brands||[])}catch(t){console.error("Error fetching brands:",t),w.error("Failed to fetch brands")}},[]);s.useMemo(()=>D.map(t=>({value:t._id,label:`${t.fullName} (${t.email})`})),[D]);const j=s.useCallback(()=>{let t=0;if(N){const a=se.find(l=>l._id===N);a&&(t+=(q==="singleShot"?a.singleShotFee:a.normalFee)||0)}return f.forEach(a=>{const l=se.find(Z=>Z._id===a);l&&(t+=(q==="singleShot"?l.singleShotFee:l.normalFee)||0)}),t},[N,f,se,q]),ze=s.useCallback(t=>{te(t);const a=j();if(a>0&&t!==""){const l=a*parseFloat(t)/100;W(l.toFixed(2))}else t===""&&W("")},[j]),Re=s.useCallback(t=>{W(t);const a=j();if(a>0&&t!==""){const l=parseFloat(t)/a*100;te(parseFloat(l.toFixed(4)).toString())}else t===""&&te("")},[j]);s.useEffect(()=>{const t=j();if(U!==""&&t>0){const a=t*parseFloat(U)/100;W(a.toFixed(2))}},[N,f,se,q]);const fe=s.useCallback(()=>{const t=j(),a=parseFloat(V)||0;return t-a},[j,V]),Te=()=>{B([...f,""])},Me=t=>{const a=[...f];a.splice(t,1),B(a)},Ue=(t,a)=>{const l=[...f];l[t]=a,B(l)},Ve=s.useCallback(t=>{if(K(t),t&&t!=="no_lead"){const a=D.find(l=>l._id===t);if(a){E(a.fullName||""),F(a.email||""),u(a.phone1||""),S(a.phone2||""),$(a.gender||""),O(a.dob?new Date(a.dob).toISOString().split("T")[0]:"");const l=Pe.map(Z=>Z.value);a.place&&!l.includes(a.place)&&a.place!=="Other"?(A("Other"),i(a.place)):(A(a.place||"Kasaragod"),i(a.otherPlace||"")),Q(a.status||""),ee(a.education||""),ae(""),B([])}}else E(""),F(""),u(""),S(""),$(""),O(""),A(""),i(""),Q(""),ee(""),ae(""),B([])},[D]),We=(t,a)=>{ge(a)};s.useEffect(()=>{(async()=>{if(v&&P)try{const a=await J.get(`${H}/students/get-next-id?brandId=${v}&enrollmentDate=${P}`,{withCredentials:!0});me(a.data.nextStudentId)}catch(a){console.error("Error fetching next student ID:",a)}else me("")})()},[v,P]);const ne=s.useCallback(t=>{const a=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t);return be(!a),a},[]),Ge=s.useCallback(t=>{const a=t.target.value;F(a),ne(a)},[ne]),Ze=s.useCallback(t=>{const a=t.target.files[0];if(!a)return;if(!a.type.startsWith("image/")){w.error("Please select an image file");return}if(a.size>5*1024*1024){w.error("File size exceeds 5MB limit");return}M(a);const l=new FileReader;l.onloadend=()=>{ie(l.result)},l.readAsDataURL(a)},[]),Je=()=>{var t;(t=re.current)==null||t.click()},xe=s.useCallback(()=>{K(""),E(""),F(""),u(""),S(""),$(""),O(""),A(""),i(""),X(""),Y(""),M(null),ie(""),Q(""),ee(""),ae(""),B([]),te(""),W(""),ge(""),me(""),ve("normal"),he(""),be(!1),Se({})},[]),ke=s.useCallback(()=>{const t={};if(!n)t.selectedLead="Please select a converted lead or 'Add without lead'";else if(n!=="no_lead"){const a=D.find(l=>l._id===n);a&&a.leadStatus!=="converted"&&(t.selectedLead="Selected lead is not in converted status")}return L.trim()||(t.fullName="Full Name is required"),v||(t.selectedBrand="Please select a brand"),b.trim()?ne(b)||(t.email="Please enter a valid email address"):t.email="Email is required",p.trim()||(t.phone1="Phone is required"),g?g==="Other"&&!r.trim()&&(t.otherPlace="Please specify the place"):t.place="Place is required",c.trim()||(t.address="Address is required"),k.trim()?/^\d{12}$/.test(k)||(t.aadharCardNumber="Aadhar Card Number must be 12 digits"):t.aadharCardNumber="Aadhar Card Number is required",N||(t.coursePreference="Primary course is required. Please select a course from the course management database."),f.forEach((a,l)=>{a||(t[`additionalCourse${l}`]=`Additional course ${l+1} is required`)}),P||(t.enrollmentDate="Enrollment date is required"),G.trim()||(t.studentId="Student ID is required"),Se(t),Object.keys(t).length===0},[n,L,v,b,p,g,r,c,k,N,f,P,G,D,ne]),He=s.useCallback(async t=>{if(t.preventDefault(),!ke()){_()&&w.error("Please fill in all required fields");return}try{ye(!0);const a=new FormData;a.append("studentId",G),a.append("fullName",L),a.append("email",b),a.append("phone1",p),a.append("phone2",C),a.append("gender",I),a.append("dob",R),a.append("place",g==="Other"?r:g),a.append("otherPlace",g==="Other"?r:""),a.append("address",c),a.append("aadharCardNumber",k),a.append("status",ce),a.append("education",ue),a.append("coursePreference",N),a.append("additionalCourses",JSON.stringify(f.filter(Z=>Z))),a.append("totalCourseValue",j()),a.append("feeType",q),a.append("discountPercentage",U||0),a.append("discountAmount",V||0),a.append("finalAmount",fe()),a.append("enrollmentDate",P),a.append("leadId",n==="no_lead"?"":n),a.append("brandId",v),T&&a.append("photo",T),(await J.post(`${H}/students/create`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"}})).status===201&&(_()&&w.success("Student created successfully!"),oe({type:"student_created",userName:(m==null?void 0:m.fullName)||"Someone",avatar:(m==null?void 0:m.avatar)||null,action:"created student",entityName:L,module:"Student Management"}),xe(),y("/manage-students"))}catch(a){console.error("Error creating student:",a),_()&&(a.response&&a.response.data&&a.response.data.message?w.error(a.response.data.message):w.error("Failed to create student. Please try again."))}finally{ye(!1)}},[ke,G,L,b,p,C,I,R,g,r,c,k,ce,ue,N,f,j,U,V,fe,P,n,v,T,xe,y,_]);return e.jsxs("div",{children:[e.jsx(Qe,{title:"New Student | DreamCRM",description:"Add new student here"}),e.jsx(ea,{pageTitle:"New Student"}),e.jsxs("form",{onSubmit:He,children:[e.jsx("div",{className:"grid grid-cols-1 gap-6",children:e.jsx("div",{className:"space-y-6",children:e.jsx(aa,{title:"Student Information",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Select Converted Lead *"}),Ne?e.jsxs("div",{className:"flex items-center justify-center h-10 bg-gray-100 dark:bg-gray-800 rounded-lg",children:[e.jsx(De,{className:"",size:"h-5 w-5"}),e.jsx("span",{className:"ml-2 text-gray-500 dark:text-gray-400",children:"Loading converted leads..."})]}):e.jsx(oa,{leads:D,value:n,onChange:Ve,placeholder:"Search and select a converted lead",error:!!o.selectedLead,disabled:Ne})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{htmlFor:"firstName",children:"Full Name *"}),e.jsx(x,{type:"text",id:"firstName",value:L,onChange:t=>E(t.target.value.toUpperCase()),error:!!o.fullName,hint:o.fullName,disabled:!!n&&n!=="no_lead",className:"uppercase"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{htmlFor:"brand",children:"Brand *"}),e.jsx(z,{options:Ie.map(t=>({value:t._id,label:`${t.name} (${t.code})`})),value:v,placeholder:"Select Brand",onChange:he,error:!!o.selectedBrand})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Email *"}),e.jsx(x,{type:"email",value:b,error:je||!!o.email,onChange:Ge,placeholder:"Enter your email",hint:o.email||(je?"This is an invalid email address.":""),disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Student Photo"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"file",ref:re,onChange:Ze,accept:"image/*",className:"hidden"}),e.jsx("button",{type:"button",onClick:Je,className:"w-20 h-20 overflow-hidden border-2 border-dashed border-gray-300 rounded-full cursor-pointer hover:border-brand-500 transition-colors flex items-center justify-center",children:de?e.jsx("img",{src:de,alt:"Preview",className:"w-full h-full object-cover"}):e.jsx("svg",{className:"w-8 h-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),de&&e.jsx("button",{type:"button",onClick:()=>{M(null),ie(""),re.current&&(re.current.value="")},className:"text-sm text-red-500 hover:text-red-700",children:"Remove"})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Phone *"}),e.jsx(Le,{selectPosition:"end",countries:Ee,placeholder:"+91 98765 43210",value:p,onChange:u,error:!!o.phone1,hint:o.phone1,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Phone (optional)"}),e.jsx(Le,{selectPosition:"end",countries:Ee,placeholder:"+91 98765 43210",value:C,onChange:S,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Gender"}),e.jsx(z,{options:ta,value:I,placeholder:"Select Gender",onChange:$,disabled:!!n&&n!=="no_lead"})]}),e.jsx("div",{className:"w-full md:w-1/4",children:e.jsx(Fe,{id:"dob",label:"Date of Birth",value:R,onChange:(t,a)=>O(a),disabled:!!n&&n!=="no_lead"})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Place *"}),e.jsx(z,{options:Pe,value:g,placeholder:"Select Place",onChange:A,error:!!o.place,hint:o.place})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{htmlFor:"otherPlace",children:"Specify Other Place *"}),e.jsx(x,{type:"text",id:"otherPlace",value:r,onChange:t=>i(t.target.value.toUpperCase()),error:!!o.otherPlace,hint:o.otherPlace,placeholder:"Enter village/city name",className:"uppercase"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{htmlFor:"address",children:"Address *"}),e.jsx(x,{type:"text",id:"address",value:c,onChange:t=>X(t.target.value.toUpperCase()),error:!!o.address,hint:o.address,placeholder:"Enter full address",className:"uppercase"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{htmlFor:"aadharCardNumber",children:"Aadhar Card Number *"}),e.jsx(x,{type:"text",id:"aadharCardNumber",value:k,onChange:t=>Y(t.target.value.replace(/\D/g,"")),error:!!o.aadharCardNumber,hint:o.aadharCardNumber,placeholder:"Enter 12-digit Aadhar number",maxLength:"12"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Current Status"}),e.jsx(z,{options:sa,value:ce,placeholder:"Select Status",onChange:Q,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Education"}),e.jsx(z,{options:ra,value:ue,placeholder:"Select Education",onChange:ee,disabled:!!n&&n!=="no_lead"})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Primary Course *"}),e.jsx(Ae,{value:N,onChange:ae,placeholder:"Search and select a course...",error:!!o.coursePreference})]}),e.jsxs("div",{className:"w-full md:w-1/4",children:[e.jsx(d,{children:"Fee Type *"}),e.jsx(z,{options:[{value:"normal",label:"Normal Fee"},{value:"singleShot",label:"Single Shot"}],value:q,onChange:ve})]})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(d,{children:"Additional Courses *"}),e.jsx(le,{type:"button",variant:"outline",size:"sm",onClick:Te,children:"Add Course"})]}),f.map((t,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(Ae,{value:t,onChange:l=>Ue(a,l),placeholder:"Search and select an additional course...",error:!!o[`additionalCourse${a}`],hint:o[`additionalCourse${a}`]})}),e.jsx(le,{type:"button",variant:"outline",size:"sm",onClick:()=>Me(a),children:"Remove"})]},a))]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{children:"Total Course Value (₹)"}),e.jsx(x,{type:"text",value:j(),readOnly:!0,className:"bg-gray-100 dark:bg-gray-800"})]}),e.jsxs("div",{children:[e.jsx(d,{children:"Discount Percentage (%)"}),e.jsx(x,{type:"number",value:U,onChange:t=>ze(t.target.value),placeholder:"0.00",min:"0",max:"100",step:"any"})]}),e.jsxs("div",{children:[e.jsx(d,{children:"Discount Amount (₹)"}),e.jsx(x,{type:"number",value:V,onChange:t=>Re(t.target.value),placeholder:"0",min:"0",step:"any"})]}),e.jsxs("div",{children:[e.jsx(d,{children:"Final Amount (₹)"}),e.jsx(x,{type:"text",value:fe().toFixed(2),readOnly:!0,className:"bg-gray-100 dark:bg-gray-800 font-bold"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"w-full md:w-1/2",children:e.jsx(Fe,{id:"enrollmentDate",label:"Enrollment Date",placeholder:"Select a date",value:P,onChange:We,error:!!o.enrollmentDate,hint:o.enrollmentDate})}),e.jsxs("div",{className:"w-full md:w-1/2",children:[e.jsx(d,{htmlFor:"studentId",children:"Student ID (Auto-generated)"}),e.jsx(x,{type:"text",id:"studentId",value:G,readOnly:!0,placeholder:"Select Brand & Date",className:"bg-gray-100 dark:bg-gray-700 font-mono",error:!!o.studentId,hint:o.studentId})]})]})]})})})}),e.jsxs("div",{className:"flex gap-4 justify-end mt-6",children:[e.jsx(le,{type:"button",onClick:xe,variant:"outline",disabled:pe,children:"Clear"}),e.jsx(le,{variant:"primary",type:"submit",disabled:pe,children:pe?e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):"Save Student"})]})]}),e.jsx(na,{position:"top-center",className:"!z-[999999]",style:{zIndex:999999}})]})}export{pa as default};
