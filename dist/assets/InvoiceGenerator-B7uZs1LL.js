import{r as i,A as X,b,c as v,y as m,j as e,m as C,P as Y,E as Z,C as h,x as p,I,B as T,K as ee,F as te}from"./index-BNEGGE57.js";const ae=()=>{const{selectedBrand:d}=i.useContext(X),[g,F]=i.useState(""),[A,j]=i.useState([]),[G,E]=i.useState(!1),[u,y]=i.useState(null),[o,x]=i.useState([{description:"",quantity:1,rate:0,amount:0}]),f=(t,a)=>{const s=new Date(t);return s.setDate(s.getDate()+a),s.toISOString().split("T")[0]},[n,l]=i.useState({invoiceDate:new Date().toISOString().split("T")[0],dueDate:f(new Date,7),tax:18,discount:0,notes:"",terms:"",status:"Draft"}),[L,O]=i.useState(0),[P,U]=i.useState(0),[q,_]=i.useState(0),[$,z]=i.useState(!1),[c,Q]=i.useState(null),[M,R]=i.useState(!1);i.useEffect(()=>{n.invoiceDate&&l(t=>({...t,dueDate:f(t.invoiceDate,7)}))},[n.invoiceDate]),i.useEffect(()=>{const a=new URLSearchParams(window.location.search).get("edit");a&&(Q(a),V(a))},[]);const V=async t=>{R(!0);try{const s=(await b.get(`${v}/invoices/${t}`,{withCredentials:!0})).data;y(s.customer),x(s.items),l({invoiceDate:s.invoiceDate.split("T")[0],dueDate:s.dueDate?s.dueDate.split("T")[0]:f(s.invoiceDate,7),tax:s.tax,discount:s.discount,notes:s.notes,terms:s.terms,status:s.status})}catch(a){console.error("Error fetching invoice for edit:",a),m.error("Failed to load invoice for editing")}finally{R(!1)}};i.useEffect(()=>{const t=setTimeout(()=>{g.length>2?B():j([])},500);return()=>clearTimeout(t)},[g]);const B=async()=>{E(!0);try{const s=((await b.get(`${v}/students/all`,{withCredentials:!0})).data.students||[]).filter(r=>{const w=r.fullName||"",D=r.phone1||"",S=r.email||"",k=g.toLowerCase();return w.toLowerCase().includes(k)||D.includes(k)||S.toLowerCase().includes(k)}).slice(0,5);j(s)}catch(t){console.error("Search error:",t)}finally{E(!1)}},K=t=>{var s;y(t),F(""),j([]);const a=((s=t.courseDetails)==null?void 0:s.courseName)||t.coursePreference;if(o.length>0&&!o[0].description&&a){const r=[...o];r[0].description=a,x(r)}},N=(t,a,s)=>{const r=[...o];r[t][a]=s,(a==="quantity"||a==="rate")&&(r[t].amount=r[t].quantity*r[t].rate),x(r)},W=()=>{x([...o,{description:"",quantity:1,rate:0,amount:0}])},H=t=>{if(o.length>1){const a=o.filter((s,r)=>r!==t);x(a)}};i.useEffect(()=>{const t=o.reduce((D,S)=>D+S.amount,0),a=parseFloat(n.tax)||0,s=parseFloat(n.discount)||0,r=t-t/(1+a/100),w=t-r;O(w),U(r),_(t-s)},[o,n.tax,n.discount]);const J=async t=>{var a,s;if(t.preventDefault(),!u){m.error("Please select a customer");return}if(!d){m.error("Please select a brand from the header");return}z(!0);try{const r={...n,customer:u._id,customerModel:"Student",items:o,subTotal:L,totalAmount:q,tax:n.tax,taxAmount:P,brand:(d==null?void 0:d._id)||(d==null?void 0:d.id)};c?(await b.patch(`${v}/invoices/${c}`,r,{withCredentials:!0}),m.success("Invoice updated successfully!"),setTimeout(()=>window.location.href="/finance/invoices",1500)):(await b.post(`${v}/invoices`,r,{withCredentials:!0}),m.success("Invoice generated successfully!"),x([{description:"",quantity:1,rate:0,amount:0}]),y(null),l({invoiceDate:new Date().toISOString().split("T")[0],dueDate:f(new Date,7),tax:18,discount:0,notes:"",terms:"",status:"Draft"}))}catch(r){console.error("Invoice submission error:",r),m.error(((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||`Failed to ${c?"update":"generate"} invoice`)}finally{z(!1)}};return M?e.jsx("div",{className:"flex justify-center p-10",children:e.jsx(C,{})}):e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsx(Y,{title:c?"Update Invoice":"Generate Invoice",description:c?"Edit existing invoice":"Create a new invoice"}),e.jsx(Z,{pageTitle:c?`Update Invoice #${c.substring(c.length-4)}`:"Generate Invoice"}),e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(h,{title:"Customer Information",children:u?e.jsxs("div",{className:"flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 dark:text-white",children:u.fullName}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:u.email}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:u.phone1})]}),e.jsx(T,{variant:"outline",size:"sm",onClick:()=>y(null),children:"Change"})]}):e.jsxs("div",{className:"relative",children:[e.jsx(p,{required:!0,children:"Search Customer"}),e.jsx(I,{placeholder:"Search by name or phone...",value:g,onChange:t=>F(t.target.value)}),G&&e.jsx("div",{className:"absolute right-3 top-9",children:e.jsx(C,{size:"sm"})}),A.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg dark:bg-gray-800 dark:border-gray-700",children:A.map(t=>e.jsxs("div",{className:"p-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 border-b last:border-0 border-gray-100 dark:border-gray-700",onClick:()=>K(t),children:[e.jsx("p",{className:"font-medium text-gray-800 dark:text-white",children:t.fullName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[t.email," | ",t.phone1]})]},t._id))})]})})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(h,{title:"Invoice Details",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(p,{required:!0,children:"Invoice Date"}),e.jsx(I,{type:"date",value:n.invoiceDate,onChange:t=>l({...n,invoiceDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(p,{children:"Due Date"}),e.jsx(I,{type:"date",value:n.dueDate,onChange:t=>l({...n,dueDate:t.target.value})})]})]})})})]}),e.jsxs(h,{title:"Line Items",children:[e.jsx("div",{className:"overflow-x-auto -mx-6",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-700 text-white",children:[e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-20 text-center",children:"Qty"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-28 text-right",children:"Rate"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-28 text-right",children:"Amount"}),e.jsx("th",{className:"px-5 py-2.5 text-[11px] font-bold uppercase tracking-wider w-16 text-center"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:o.map((t,a)=>e.jsxs("tr",{className:"hover:bg-gray-50/30 transition-colors",children:[e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"text",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-[13px] text-gray-900 dark:text-gray-100 font-medium",placeholder:"Item description",value:t.description,onChange:s=>N(a,"description",s.target.value)})}),e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"number",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-center text-[13px] text-gray-900 dark:text-gray-100",value:t.quantity,onChange:s=>N(a,"quantity",parseFloat(s.target.value)||0),min:"1"})}),e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"number",className:"w-full bg-transparent border-b border-transparent focus:border-brand-500 focus:outline-none py-1 text-right text-[13px] text-gray-900 dark:text-gray-100",value:t.rate,onChange:s=>N(a,"rate",parseFloat(s.target.value)||0),min:"0"})}),e.jsx("td",{className:"px-5 py-2 text-right font-semibold text-[13px] text-gray-900 dark:text-gray-100",children:t.amount.toLocaleString()}),e.jsx("td",{className:"px-5 py-2 text-center",children:e.jsx("button",{type:"button",onClick:()=>H(a),className:"text-gray-400 hover:text-red-500 transition-colors p-1",children:e.jsx(ee,{className:"size-4"})})})]},a))})]})}),e.jsx("div",{className:"mt-4",children:e.jsxs(T,{type:"button",variant:"outline",size:"sm",onClick:W,className:"flex items-center text-xs h-8",children:[e.jsx(te,{className:"size-3.5 mr-1.5"}),"Add Row"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsx("div",{children:e.jsx(h,{title:"Notes & Terms",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(p,{className:"text-[12px]",children:"Customer Notes"}),e.jsx("textarea",{className:"w-full p-2.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-[13px] focus:ring-1 focus:ring-brand-500 outline-none transition-all",rows:"2",value:n.notes,onChange:t=>l({...n,notes:t.target.value}),placeholder:"Thanks for your business"})]}),e.jsxs("div",{children:[e.jsx(p,{className:"text-[12px]",children:"Terms & Conditions"}),e.jsx("textarea",{className:"w-full p-2.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-[13px] focus:ring-1 focus:ring-brand-500 outline-none transition-all italic",rows:"2",value:n.terms,onChange:t=>l({...n,terms:t.target.value}),placeholder:"Please pay by the due date"})]})]})})}),e.jsx("div",{children:e.jsx(h,{title:"Summary",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Base Amount (Tax Excl.)"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-medium",children:L.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})})]}),e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["Tax (",n.tax,"% Included)"]}),e.jsx("span",{className:"text-gray-900 dark:text-white font-medium",children:P.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})})]}),e.jsxs("div",{className:"flex justify-between items-center text-[13px]",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Discount (Amt)"}),e.jsx("div",{className:"w-20",children:e.jsx("input",{type:"number",className:"w-full p-1.5 border border-gray-200 rounded dark:bg-gray-800 dark:border-gray-700 text-right text-[13px] focus:ring-1 focus:ring-brand-500 outline-none text-red-500",value:n.discount,onChange:t=>l({...n,discount:t.target.value})})})]}),e.jsx("div",{className:"pt-2 border-t border-gray-100 dark:border-gray-800",children:e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("span",{className:"text-gray-900 dark:text-white font-bold text-[14px]",children:"Total"}),e.jsx("span",{className:"text-brand-600 dark:text-brand-400 font-bold text-xl",children:q.toLocaleString("en-IN",{style:"currency",currency:"INR"})})]})}),e.jsxs("div",{className:"pt-4",children:[e.jsx(T,{type:"submit",variant:"primary",className:"w-full py-3 h-12 rounded shadow-sm hover:shadow transition-all font-bold text-[15px]",disabled:$,children:$?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(C,{size:"sm"}),e.jsx("span",{children:"Processing..."})]}):c?"Update Invoice":"Generate Invoice"}),c&&e.jsx("button",{type:"button",onClick:()=>window.location.href="/finance/invoices",className:"w-full mt-2 py-2 text-sm text-gray-500 hover:text-gray-700 transition-colors",children:"Discard Changes"}),e.jsxs("p",{className:"text-center text-[11px] text-gray-400 mt-3 italic",children:["* ",c?"Changes will be applied immediately.":"Stored as Draft by default."]})]})]})})})]})]})]})};export{ae as default};
