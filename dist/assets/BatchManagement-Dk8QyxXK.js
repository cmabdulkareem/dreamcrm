const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-C1kKzVV0.js","assets/index-BNEGGE57.js","assets/index.n2k6cYEa.css"])))=>i.map(i=>d[i]);
import{af as Se,i as xe,v as me,f as ue,r as l,ad as $e,b as B,c as L,y as h,j as e,m as fe,a3 as Be,h as ve,M as De,B as se,x as ae,I as le,H as Ce,A as Te,P as Fe,E as He,C as Oe,n as We}from"./index-BNEGGE57.js";import{S as ze}from"./StudentProfileModal-D1ddp5oS.js";import{S as Re}from"./group-C53OQBfh.js";function Ue({batchId:n,batchSubject:I,batchStartDate:c,batchEndDate:y,brandName:u}){const{user:g}=Se(),w=xe(g)||me(g)||ue(g),[k,H]=l.useState([]),[A,E]=l.useState(!0),[M,p]=l.useState(!1),[v,P]=l.useState(null),[G,J]=l.useState(null),[O,U]=l.useState(!1),[f,x]=l.useState(null),[j,a]=l.useState(null);$e.useRef(null);const[o,N]=l.useState([]),[S,r]=l.useState(""),[d,_]=l.useState(!1),[T,K]=l.useState(!1),ee={studentId:"",studentName:"",dob:"",phoneNumber:"",parentPhoneNumber:""},[D,Y]=l.useState(ee),[C,b]=l.useState(ee);l.useEffect(()=>{z()},[n]),l.useEffect(()=>{M&&o.length===0&&R()},[M]);const z=async()=>{try{E(!0);const t=await B.get(`${L}/batches/${n}/students`,{withCredentials:!0});H(t.data.students)}catch(t){console.error("Error fetching students:",t)}finally{E(!1)}},R=async()=>{try{_(!0);const t=await B.get(`${L}/students/all`,{withCredentials:!0});N(t.data.students)}catch{h.error("Failed to fetch student list for selection.")}finally{_(!1)}},V=o.filter(t=>{var s,$;return k.some(q=>q.studentId&&q.studentId._id===t._id||q.studentId===t._id)?!1:((s=t.fullName)==null?void 0:s.toLowerCase().includes(S.toLowerCase()))||(($=t.phone1)==null?void 0:$.includes(S))||t.studentId&&t.studentId.toLowerCase().includes(S.toLowerCase())}),X=async t=>{const i={studentId:t._id,studentName:t.fullName,dob:t.dob?new Date(t.dob).toISOString().split("T")[0]:"",phoneNumber:t.phone1,parentPhoneNumber:t.phone2||""};try{const s=await B.post(`${L}/batches/${n}/students`,i,{withCredentials:!0});H($=>[...$,s.data.student]),r(""),K(!1),h.success(`${t.fullName} added successfully!`)}catch(s){console.error("Error adding student:",s),s.response&&s.response.data&&s.response.data.message?h.error(s.response.data.message):h.error("Failed to add student.")}},te=async t=>{if(t.preventDefault(),!D.studentName||!D.phoneNumber){h.error("Student Name and Phone Number are required.");return}const i={...D};(!i.studentId||i.studentId.length<24)&&delete i.studentId;try{const s=await B.post(`${L}/batches/${n}/students`,i,{withCredentials:!0});H([...k,s.data.student]),Y(ee),h.success("Student added successfully!")}catch(s){console.error(s),s.response&&s.response.data&&s.response.data.message?h.error(s.response.data.message):h.error("Failed to add student.")}},ne=t=>{const i=t.studentId&&typeof t.studentId=="object"?t.studentId:t;x(i),U(!0)},de=t=>{const i=t.studentId&&typeof t.studentId=="object"?t.studentId:t,s=t.studentId&&typeof t.studentId=="object";return{id:s?i.studentId||"-":t.studentId||"-",name:s?i.fullName:t.studentName,dob:i.dob,phone:s?i.phone1:t.phoneNumber,parentPhone:s?i.phone2:t.parentPhoneNumber,course:s&&(i.courseName||i.coursePreference)||"",_id:t._id}},Z=async t=>{if(t.preventDefault(),!C.studentName||!C.phoneNumber){h.error("Student Name and Phone Number are required.");return}try{await B.put(`${L}/batches/students/${v}`,C,{withCredentials:!0}),z(),P(null),h.success("Student updated successfully!")}catch{h.error("Failed to update student.")}},je=async t=>{if(window.confirm("Are you sure you want to remove this student?"))try{await B.delete(`${L}/batches/students/${t}`,{withCredentials:!0}),H(k.filter(i=>i._id!==t)),h.success("Student removed successfully.")}catch{h.error("Failed to remove student.")}},ke=t=>{j&&j._id===t._id?a(null):a(t)},Ne=async t=>{var i;if(j&&window.confirm(`Are you sure you want to merge all attendance from ${j.studentName} into ${t.studentName}? ${j.studentName} will be removed from this batch.`))try{E(!0);const s=await B.post(`${L}/batches/${n}/students/merge-attendance`,{sourceId:j._id,targetId:t._id},{withCredentials:!0});h.success(s.data.message),a(null),z()}catch(s){console.error("Merge error:",s);const $=(i=s.response)==null?void 0:i.data,q=$!=null&&$.error?`${$.message}: ${$.error}`:($==null?void 0:$.message)||s.message||"Failed to merge attendance.";h.error(q,{autoClose:7e3})}finally{E(!1)}},we=async t=>{var i;J(t._id);try{const s=F=>new Promise((Q,oe)=>{const W=new Image;W.crossOrigin="anonymous",W.onload=()=>Q(W),W.onerror=()=>{console.error(`Failed to load image: ${F}`),oe(new Error(`Failed to load: ${F}`))},W.src=F}),ie=document.createElement("canvas");ie.width=1550,ie.height=2400;const m=ie.getContext("2d");let ce="/images/cc_id_temp.png";if(u){const F=u.toLowerCase();F.includes("cadd")?ce="/images/cc_id_temp.png":F.includes("synergy")?ce="/images/syn_id_temp.png":F.includes("dream")?ce="/images/dz_id_temp.png":F.includes("livewire")&&(ce="/images/lw_id_temp.png")}const Me=await s(ce);m.drawImage(Me,0,0,1550,2400);const ge=de(t);let re=((i=t.studentId)==null?void 0:i.photo)||t.photo;re&&!re.startsWith("http")&&!re.startsWith("data:")&&(re=`${L.replace("/api","")}/${re.replace(/^\//,"")}`),re||(re="/images/user/avatar.png");try{const F=await s(re),Q=345,oe=422,W=905,pe=Q+W/2,be=oe+W/2,ye=W/2;m.save(),m.beginPath(),m.arc(pe,be,ye,0,Math.PI*2),m.clip(),m.drawImage(F,Q,oe,W,W),m.restore(),m.strokeStyle="#000",m.lineWidth=5,m.beginPath(),m.arc(pe,be,ye,0,Math.PI*2),m.stroke()}catch(F){console.error("Could not load student photo, drawing placeholder",F);const Q=345,oe=422,W=905,pe=Q+W/2,be=oe+W/2,ye=W/2;m.fillStyle="#f3f4f6",m.beginPath(),m.arc(pe,be,ye,0,Math.PI*2),m.fill()}m.fillStyle="#021349",m.font="bold 100px Arial",m.fillText(ge.name||"Student Name",145,1595),m.fillStyle="#000000",m.font="bold 75px Arial",m.fillText(ge.course||"",145,1680),m.fillStyle="#021349",m.font="normal 70px Arial",m.fillText(ge.id||"Student ID",145,1800);const _e=ie.toDataURL("image/jpeg",.95);m.clearRect(0,0,1550,2400);const Ae=await s("/images/cc_id_temp_back.png");if(m.drawImage(Ae,0,0,1550,2400),c&&y){const F=new Date(c).toLocaleDateString(),Q=new Date(y).toLocaleDateString();m.fillStyle="#021349",m.font="bold 70px Arial",m.textAlign="center",m.fillText(`Start Date: ${F}`,1550/2,2030),m.fillText(`End Date: ${Q}`,1550/2,2150)}const Le=ie.toDataURL("image/jpeg",.95),{jsPDF:Ee}=await Be(async()=>{const{jsPDF:F}=await import("./jspdf.es.min-C1kKzVV0.js").then(Q=>Q.j);return{jsPDF:F}},__vite__mapDeps([0,1,2])),he=new Ee({orientation:"portrait",unit:"pt",format:[1550*.75,2400*.75]});he.addImage(_e,"JPEG",0,0,1550*.75,2400*.75),he.addPage(),he.addImage(Le,"JPEG",0,0,1550*.75,2400*.75);const Pe=`${(ge.name||"Student").trim().replace(/[^a-z0-9]/gi,"_")}_ID_Card.pdf`;he.save(Pe)}catch(s){console.error("ID Generation Error:",s),h.error(`Error: ${s.message}`)}finally{J(null)}};return A?e.jsx(fe,{className:"py-10"}):e.jsxs("div",{className:"mt-4",children:[j&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-lg flex justify-between items-center animate-pulse",children:[e.jsxs("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("span",{className:"font-bold",children:"Merge Mode:"})," Select a target student to move ",e.jsxs("span",{className:"underline",children:[j.studentName,"'s"]})," attendance into."]}),e.jsx("button",{onClick:()=>a(null),className:"text-xs px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200",children:"Cancel"})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h6",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:["Total Students: ",k.length]}),w&&e.jsx("button",{onClick:()=>p(!M),className:"text-xs font-semibold px-3 py-1 bg-brand-50 text-brand-600 rounded-md hover:bg-brand-100 dark:bg-brand-900/30 dark:text-brand-400",children:M?"Done Adding":"+ Add Student"})]}),M&&e.jsxs("div",{className:"mb-4 p-4 bg-brand-50/50 dark:bg-brand-900/20 rounded-lg border border-brand-100 dark:border-brand-800",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-800 dark:text-white mb-3",children:"Add Student to Batch"}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Search Student (from Manage Students)"}),e.jsx("input",{type:"text",autoFocus:!0,placeholder:"Search by name, phone or ID...",className:"w-full text-sm border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600",value:S,onChange:t=>{r(t.target.value),K(!0)},onFocus:()=>K(!0),onBlur:()=>{setTimeout(()=>{K(!1)},200)}}),T&&S&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg max-h-60 overflow-y-auto",children:d?e.jsx("div",{className:"p-2 text-xs text-gray-500",children:"Loading..."}):V.length>0?V.map(t=>e.jsxs("div",{className:"px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-50 dark:border-gray-700/50 last:border-0",onMouseDown:i=>i.preventDefault(),onClick:()=>X(t),children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.fullName}),e.jsxs("div",{className:"text-xs text-gray-500",children:[t.studentId||"No ID"," | ",t.phone1]})]},t._id)):e.jsx("div",{className:"p-2 text-xs text-gray-500",children:"No matching students found."})})]}),e.jsxs("div",{className:"border-t border-gray-100 dark:border-gray-700 pt-3 mt-3",children:[e.jsx("div",{className:"text-xs text-gray-400 mb-2 italic",children:"Or enter details manually if not found in search:"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-5 gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"ID (Opt)"}),e.jsx("input",{type:"text",value:D.studentId,onChange:t=>Y({...D,studentId:t.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Custom ID"})]}),e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Name *"}),e.jsx("input",{type:"text",value:D.studentName,onChange:t=>Y({...D,studentName:t.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"DOB"}),e.jsx("input",{type:"date",value:D.dob,onChange:t=>Y({...D,dob:t.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Phone *"}),e.jsx("input",{type:"text",value:D.phoneNumber,onChange:t=>Y({...D,phoneNumber:t.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Phone"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Parent Phone"}),e.jsx("input",{type:"text",value:D.parentPhoneNumber,onChange:t=>Y({...D,parentPhoneNumber:t.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white",placeholder:"Parent (Opt)"})]})]}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{onClick:te,className:"px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 shadow-sm",children:"Add Manually"})})]})]}),e.jsx("div",{className:"overflow-x-auto border border-gray-100 dark:border-gray-700 rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Student ID"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"DOB"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Phone"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Parent Phone"}),w&&e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:[k.map(t=>{const i=de(t);return e.jsx("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:v===t._id?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:C.studentId,disabled:!0,className:"w-full text-sm border-gray-300 rounded bg-gray-100 cursor-not-allowed dark:bg-gray-700 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:C.studentName,onChange:s=>b({...C,studentName:s.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"date",value:C.dob?new Date(C.dob).toISOString().split("T")[0]:"",onChange:s=>b({...C,dob:s.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:C.phoneNumber,onChange:s=>b({...C,phoneNumber:s.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:C.parentPhoneNumber,onChange:s=>b({...C,parentPhoneNumber:s.target.value}),className:"w-full text-sm border-gray-300 rounded dark:bg-gray-800 dark:text-white"})}),e.jsxs("td",{className:"px-4 py-2 text-right",children:[e.jsx("button",{onClick:Z,className:"text-green-600 hover:text-green-800 mr-2",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:()=>P(null),className:"text-red-600 hover:text-red-800",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:i.id}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-900 dark:text-white",children:e.jsx("span",{className:"cursor-pointer hover:text-brand-600 transition-colors font-medium",onClick:()=>ne(t),children:i.name})}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:i.dob?new Date(i.dob).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:i.phone}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600 dark:text-gray-400",children:i.parentPhone||"-"}),w&&e.jsxs("td",{className:"px-4 py-2 text-right flex items-center justify-end space-x-2",children:[j?j._id!==t._id?e.jsx("button",{onClick:()=>Ne(t),className:"p-1.5 text-blue-600 hover:bg-blue-50 rounded-md transition-colors border border-blue-200 bg-blue-50/50",title:"Merge Here",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})}):e.jsx("span",{className:"text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200",children:"Source"}):e.jsx("button",{onClick:()=>ke(t),className:"p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors",title:"Mark for Attendance Merge",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})})}),e.jsx("button",{onClick:()=>we(t),disabled:G===t._id,className:`p-1.5 rounded-md transition-colors ${G===t._id?"text-gray-300":"text-brand-500 hover:bg-brand-50"}`,title:"Generate ID Card",children:G===t._id?e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})}),e.jsx("button",{onClick:()=>{P(t._id),b(t)},className:"p-1.5 text-gray-400 hover:text-brand-600 hover:bg-gray-100 rounded-md transition-colors",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})})}),e.jsx("button",{onClick:()=>je(t._id),className:"p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})},t._id)}),!M&&k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-10 text-center text-sm text-gray-500",children:"No students enrolled in this batch yet."})})]})]})}),e.jsx(ze,{isOpen:O,onClose:()=>U(!1),student:f})]})}function Ve({isOpen:n,onClose:I,batch:c}){const{user:y}=Se(),[u,g]=l.useState([]),[w,k]=l.useState(!1),[H,A]=l.useState(!1),[E,M]=l.useState(new Date().toLocaleDateString("en-CA")),[p,v]=l.useState({}),[P,G]=l.useState(!1),J=y&&c&&y.fullName===c.instructorName||ve(y,"Instructor"),O=(xe(y)||me(y)||ue(y)||J)&&!ve(y,"Academic Coordinator");l.useEffect(()=>{n&&c&&(M(new Date().toLocaleDateString("en-CA")),U())},[n,c]);const U=async()=>{k(!0);try{const o=(await B.get(`${L}/batches/${c._id}/students`,{withCredentials:!0})).data.students;g(o);try{const S=(await B.get(`${L}/batches/${c._id}/attendance?date=${E}`,{withCredentials:!0})).data.attendance[0],r={};S?S.records.forEach(d=>{r[d.studentId]={status:d.status,remarks:d.remarks}}):o.forEach(d=>{r[d._id]={status:"Present",remarks:""}}),v(r)}catch(N){console.error("No existing attendance found or error fetching",N);const S={};o.forEach(r=>{S[r._id]={status:"Present",remarks:""}}),v(S)}}catch(a){console.error("Failed to fetch data:",a),h.error("Failed to load students.")}finally{k(!1)}},f=a=>{if(!c)return!1;const o=new Date(a),N=new Date(c.startDate),S=new Date(c.expectedEndDate);return o.setHours(0,0,0,0),N.setHours(0,0,0,0),S.setHours(0,0,0,0),o>=N&&o<=S},x=(a,o)=>{if(O){if(!f(E)){h.error("Attendance date must be within batch duration.");return}v(N=>({...N,[a]:{...N[a],status:o}}))}},j=async()=>{var a,o;if(O){if(!f(E)){h.error("Cannot mark attendance outside of batch dates.");return}A(!0);try{const N=Object.keys(p).map(S=>({studentId:S,status:p[S].status,remarks:p[S].remarks}));await B.post(`${L}/batches/${c._id}/attendance`,{date:E,records:N},{withCredentials:!0}),h.success("Attendance marked successfully!"),I()}catch(N){console.error("Error marking attendance:",N),h.error(((o=(a=N.response)==null?void 0:a.data)==null?void 0:o.message)||"Failed to mark attendance.")}finally{A(!1)}}};return n?e.jsx(De,{isOpen:n,onClose:I,className:"max-w-4xl p-0 h-[90vh] sm:h-auto sm:max-h-[90vh]",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 sm:p-6 border-b border-gray-100 dark:border-gray-700 shrink-0 pr-12 sm:pr-14",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white",children:O?"Mark Attendance":"View Attendance"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400",children:[c==null?void 0:c.batchName," | ",new Date().toLocaleDateString("en-US",{day:"numeric",month:"short",year:"numeric"})]})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar",children:w?e.jsx(fe,{className:"py-20"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Student Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:u.map(a=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-4 text-sm font-medium text-gray-900 dark:text-white",children:[e.jsx("div",{children:a.studentName}),e.jsx("div",{className:"text-xs font-normal text-gray-500 dark:text-gray-400 mt-1",children:a.phoneNumber})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400",children:e.jsx("div",{className:"flex gap-2",children:["Present","Absent","Late","Excused","Holiday"].map(o=>{var N;return e.jsx("button",{onClick:()=>x(a._id,o),disabled:!O,className:`px-3 py-1 rounded-full text-xs font-medium transition-colors border 
                                                            ${((N=p[a._id])==null?void 0:N.status)===o?o==="Present"?"bg-green-100 text-green-800 border-green-200":o==="Absent"?"bg-red-100 text-red-800 border-red-200":o==="Late"?"bg-yellow-100 text-yellow-800 border-yellow-200":o==="Holiday"?"bg-purple-100 text-purple-800 border-purple-200":"bg-blue-100 text-blue-800 border-blue-200":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600"}
                                                            ${O?"":"cursor-default opacity-80"}
                                                        `,children:o},o)})})})]},a._id))})]})}),e.jsxs("div",{className:"md:hidden",children:[e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2 italic",children:"Attendance Legend"}),e.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-2",children:[{l:"P",n:"Present",c:"bg-green-100 text-green-800 border-green-200"},{l:"A",n:"Absent",c:"bg-red-100 text-red-800 border-red-200"},{l:"L",n:"Late",c:"bg-yellow-100 text-yellow-800 border-yellow-200"},{l:"E",n:"Excused",c:"bg-blue-100 text-blue-800 border-blue-200"},{l:"H",n:"Holiday",c:"bg-purple-100 text-purple-800 border-purple-200"}].map(a=>e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:`w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold border ${a.c}`,children:a.l}),e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:a.n})]},a.l))})]}),e.jsx("div",{className:"space-y-4",children:u.map(a=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-900 dark:text-white",children:a.studentName}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-0.5",children:a.phoneNumber})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:["Present","Absent","Late","Excused","Holiday"].map(o=>{var N;return e.jsx("button",{onClick:()=>x(a._id,o),disabled:!O,className:`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold transition-colors border
                                                    ${((N=p[a._id])==null?void 0:N.status)===o?o==="Present"?"bg-green-100 text-green-800 border-green-200":o==="Absent"?"bg-red-100 text-red-800 border-red-200":o==="Late"?"bg-yellow-100 text-yellow-800 border-yellow-200":o==="Holiday"?"bg-purple-100 text-purple-800 border-purple-200":"bg-blue-100 text-blue-800 border-blue-200":"bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600"}
                                                    ${O?"":"cursor-default opacity-80"}
                                                `,children:o.charAt(0)},o)})})]},a._id))})]})]})}),e.jsxs("div",{className:"mt-auto p-4 sm:p-6 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3 shrink-0",children:[e.jsx(se,{variant:"outline",onClick:I,className:"px-4 py-2",children:"Close"}),O&&e.jsx(se,{variant:"primary",onClick:j,loading:H,className:"px-6 py-2",children:"Save Attendance"})]})]})}):null}function qe({isOpen:n,onClose:I,batch:c}){const[y,u]=l.useState(!1),[g,w]=l.useState(new Date().getMonth()+1),[k,H]=l.useState(new Date().getFullYear()),[A,E]=l.useState([]),[M,p]=l.useState([]),v=["January","February","March","April","May","June","July","August","September","October","November","December"],P=new Date().getFullYear(),G=[P-1,P,P+1];l.useEffect(()=>{n&&c&&J()},[n,c,g,k]);const J=async()=>{u(!0);try{const d=(await B.get(`${L}/batches/${c._id}/students`,{withCredentials:!0})).data.students;p(d);const _=await B.get(`${L}/batches/${c._id}/attendance?month=${g}&year=${k}`,{withCredentials:!0});E(_.data.attendance)}catch(r){console.error("Failed to fetch monthly attendance:",r),h.error("Failed to load attendance report.")}finally{u(!1)}},U=((r,d)=>new Date(d,r,0).getDate())(g,k),f=Array.from({length:U},(r,d)=>d+1),x=()=>{const r={},d={},_={present:0,absent:0,late:0,excused:0,holiday:0},T={},K=new Date,ee=new Date(K.getFullYear(),K.getMonth(),K.getDate()),D=c!=null&&c.startDate?new Date(c.startDate):new Date(0),Y=new Date(D.getFullYear(),D.getMonth(),D.getDate());M.forEach(b=>{r[b._id]={},d[b._id]={present:0,absent:0,late:0,excused:0,holiday:0,totalSessions:0}});const C={};A.forEach(b=>{const z=new Date(b.date),R=z.getDate();b.records.forEach(V=>{r[V.studentId]&&(r[V.studentId][R]=V.status,(!C[V.studentId]||z<C[V.studentId])&&(C[V.studentId]=z))})});for(let b=1;b<=U;b++){const z=new Date(k,g-1,b);z>=Y&&z<=ee&&(T[b]||(T[b]={present:0,absent:0,late:0,excused:0,holiday:0}),M.forEach(R=>{const V=new Date(R.createdAt);V.setHours(0,0,0,0);let X=V;C[R._id]&&C[R._id]<X&&(X=new Date(C[R._id]),X.setHours(0,0,0,0)),X<Y&&(X=Y);const te=d[R._id];let ne=r[R._id][b],de=!1,Z=ne;if(ne)ne!=="Holiday"&&(de=!0);else if(z>=X)if(de=!0,z.getDay()===0){const je=b>1,ke=b<U,Ne=new Date(z.getTime()-864e5),we=new Date(z.getTime()+864e5),t=Ne>=X,i=we<=ee,s=je&&t&&r[R._id][b-1]==="Absent",$=ke&&i&&r[R._id][b+1]==="Absent";let q=!1;t&&i?q=s&&$:t?q=s:i&&(q=$),Z=q?"Absent":"Present",r[R._id][b]=Z}else Z="Present",r[R._id][b]="Present";if(!de){ne==="Holiday"&&(te.holiday++,_.holiday++,T[b].holiday++);return}te.totalSessions++,Z==="Absent"?(te.absent++,_.absent++,T[b].absent++):(te.present++,Z==="Present"?(_.present++,T[b].present++):Z==="Late"?(te.late++,_.late++,T[b].late++):Z==="Excused"&&(te.excused++,_.excused++,T[b].excused++))}))}return{studentMap:r,statsMap:d,monthlySummary:_,dailyStats:T}},{studentMap:j,statsMap:a,monthlySummary:o,dailyStats:N}=x(),S=r=>{if(!r)return e.jsx("span",{className:"text-gray-200 text-xs",children:"-"});let d="text-gray-500",_=r.charAt(0);switch(r){case"Present":d="bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800";break;case"Absent":d="bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800";break;case"Late":d="bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800";break;case"Excused":d="bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800";break;case"Holiday":d="bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-purple-800";break;default:d="bg-gray-50 text-gray-400 border-gray-100 dark:bg-gray-800/50 dark:text-gray-600 dark:border-gray-800";break}return e.jsx("div",{className:`w-6 h-6 flex items-center justify-center rounded-full text-[10px] sm:text-xs font-bold mx-auto border ${d}`,children:_})};return n?e.jsxs(De,{isOpen:n,onClose:I,className:"max-w-6xl p-6 h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 shrink-0 pr-10 sm:pr-12",children:[e.jsxs("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900 dark:text-white",children:["Monthly Attendance Report - ",c==null?void 0:c.batchName]}),e.jsxs("div",{className:"flex gap-3 sm:gap-4",children:[e.jsx("select",{value:g,onChange:r=>w(Number(r.target.value)),className:"p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:v.map((r,d)=>e.jsx("option",{value:d+1,children:r},d))}),e.jsx("select",{value:k,onChange:r=>H(Number(r.target.value)),className:"p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white",children:G.map(r=>e.jsx("option",{value:r,children:r},r))})]})]}),!y&&e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-600 shrink-0",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3 tracking-widest",children:"Monthly Status Indicators"}),e.jsx("div",{className:"flex flex-wrap gap-x-8 gap-y-3",children:[{l:"P",n:"Present",c:"bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400",count:o.present},{l:"A",n:"Absent",c:"bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-400",count:o.absent},{l:"L",n:"Late",c:"bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400",count:o.late},{l:"E",n:"Excused",c:"bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400",count:o.excused},{l:"H",n:"Holiday",c:"bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400",count:o.holiday}].map(r=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold border shadow-sm ${r.c}`,children:r.l}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-medium text-gray-400 dark:text-gray-500 uppercase leading-none mb-1",children:r.n}),e.jsx("span",{className:"text-sm font-bold text-gray-800 dark:text-white leading-none",children:r.count})]})]},r.l))})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg",children:y?e.jsx(fe,{className:"h-full"}):e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 border-collapse",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sticky left-0 bg-gray-50 dark:bg-gray-700 z-20 border-r dark:border-gray-600 min-w-[150px] sm:min-w-[200px]",children:"Student Name"}),f.map(r=>{const d=new Date(k,g-1,r),_=["S","M","T","W","T","F","S"][d.getDay()],T=d.getDay()===0;return e.jsxs("th",{className:`px-1 py-2 text-center text-[10px] font-medium min-w-[32px] border-l dark:border-gray-600 ${T?"text-red-600 bg-red-50 dark:bg-red-900/20":"text-gray-500 dark:text-gray-300"}`,children:[e.jsx("div",{className:"mb-0.5",children:_}),e.jsx("div",{className:"text-[11px]",children:r})]},r)}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700 sticky right-0 z-20 border-l dark:border-gray-600",children:"Total"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700 sticky right-0 z-20 border-l dark:border-gray-600",children:"%"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:M.map(r=>{const d=a[r._id]||{present:0,totalSessions:0},_=d.totalSessions>0?Math.round(d.present/d.totalSessions*100):0;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white sticky left-0 bg-white dark:bg-gray-800 z-10 border-r dark:border-gray-600 max-w-[150px] sm:max-w-none truncate",children:r.studentName}),f.map(T=>{var D;const ee=new Date(k,g-1,T).getDay()===0;return e.jsx("td",{className:`px-1 py-1 text-center border-l border-gray-100 dark:border-gray-700 ${ee?"bg-red-50/50 dark:bg-red-900/5":""}`,children:S((D=j[r._id])==null?void 0:D[T])},T)}),e.jsxs("td",{className:"px-4 py-2 text-center text-sm text-gray-900 dark:text-white sticky right-0 bg-white dark:bg-gray-800 z-10 border-l dark:border-gray-600 font-semibold",children:[e.jsx("span",{className:"text-green-600",children:d.present})," / ",d.totalSessions]}),e.jsx("td",{className:"px-4 py-2 text-center text-sm sticky right-0 bg-white dark:bg-gray-800 z-10 border-l dark:border-gray-600 font-bold",children:e.jsxs("span",{className:_>=75?"text-green-600":_>=50?"text-yellow-600":"text-red-600",children:[_,"%"]})})]},r._id)})}),e.jsxs("tfoot",{className:"bg-gray-50 dark:bg-gray-700/30 sticky bottom-0 z-10",children:[e.jsxs("tr",{className:"border-t-2 border-gray-200 dark:border-gray-600",children:[e.jsx("td",{className:"px-4 py-2 font-bold text-[10px] uppercase tracking-wider text-gray-500 sticky left-0 bg-gray-50 dark:bg-gray-700 z-10 border-r dark:border-gray-600",children:"Total Presents"}),f.map(r=>{var d;return e.jsx("td",{className:"px-1 py-1 text-center font-bold text-[11px] border-l border-gray-100 dark:border-gray-700 text-green-600",children:((d=N[r])==null?void 0:d.present)||0},r)}),e.jsx("td",{colSpan:2,className:"bg-gray-50 dark:bg-gray-700"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 font-bold text-[10px] uppercase tracking-wider text-gray-500 sticky left-0 bg-gray-50 dark:bg-gray-700 z-10 border-r dark:border-gray-600",children:"Total Absents"}),f.map(r=>{var d;return e.jsx("td",{className:"px-1 py-1 text-center font-bold text-[11px] border-l border-gray-100 dark:border-gray-700 text-red-600",children:((d=N[r])==null?void 0:d.absent)||0},r)}),e.jsx("td",{colSpan:2,className:"bg-gray-50 dark:bg-gray-700"})]})]})]})}),e.jsx("div",{className:"mt-6 flex justify-end shrink-0",children:e.jsx(se,{variant:"outline",onClick:I,className:"px-6 py-2.5",children:"Close"})})]}):null}function Ie({isOpen:n,onClose:I,onCreated:c,onUpdated:y,batch:u}){const[g,w]=l.useState({batchName:"",instructorName:"",mode:"online",subject:"",startDate:"",expectedEndDate:"",batchTime:{from:"",to:""},instructor:""}),[k,H]=l.useState(!1),[A,E]=l.useState([]),[M,p]=l.useState(""),v=!!u;l.useEffect(()=>{var f,x;n&&((async()=>{try{const a=await B.get(`${L}/users/dropdown?roles=Instructor`,{withCredentials:!0}),o=["Instructor"],S=a.data.users.filter(r=>r.roles&&r.roles.some(d=>o.includes(d))).map(r=>({value:r._id,label:r.fullName}));E(S)}catch(a){console.error("Failed to fetch instructors:",a),h.error("Failed to load instructors")}})(),u?w({batchName:u.batchName||"",instructorName:u.instructorName||"",mode:u.mode||"online",subject:u.subject||"",startDate:u.startDate?new Date(u.startDate).toISOString().split("T")[0]:"",expectedEndDate:u.expectedEndDate?new Date(u.expectedEndDate).toISOString().split("T")[0]:"",batchTime:{from:((f=u.batchTime)==null?void 0:f.from)||"",to:((x=u.batchTime)==null?void 0:x.to)||""},instructor:u.instructor||""}):(w({batchName:"",instructorName:"",mode:"online",subject:"",startDate:"",expectedEndDate:"",batchTime:{from:"",to:""},instructor:""}),p("")))},[n,u]),l.useEffect(()=>{if(v&&g.instructorName&&A.length>0){const f=A.find(x=>x.label===g.instructorName);f&&p(f.value)}},[v,g.instructorName,A]);const P=f=>{const{name:x,value:j}=f.target;if(x.includes("batchTime.")){const a=x.split(".")[1];w(o=>({...o,batchTime:{...o.batchTime,[a]:j}}))}else w(a=>({...a,[x]:j}))},G=f=>{p(f);const x=A.find(j=>j.value===f);x&&w(j=>({...j,instructorName:x.label,instructor:f}))},J=f=>{w(x=>({...x,mode:f}))},O=async f=>{var x,j;f.preventDefault(),H(!0);try{if(v){const a=await B.put(`${L}/batches/${u._id}`,g,{withCredentials:!0});h.success("Batch updated successfully!"),y&&y(a.data.batch)}else{const a=await B.post(`${L}/batches`,g,{withCredentials:!0});h.success("Batch created successfully!"),c&&c(a.data.batch)}I()}catch(a){console.error("Error saving batch:",a),h.error(((j=(x=a.response)==null?void 0:x.data)==null?void 0:j.message)||`Failed to ${v?"update":"create"} batch.`)}finally{H(!1)}},U=[{value:"online",label:"Online"},{value:"offline",label:"Offline"}];return e.jsxs(De,{isOpen:n,onClose:I,className:"max-w-2xl p-6 lg:p-10",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-6",children:v?"Edit Batch Details":"Create New Batch"}),e.jsxs("form",{onSubmit:O,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx(ae,{htmlFor:"batchName",children:"Batch Name"}),e.jsx(le,{type:"text",id:"batchName",name:"batchName",required:!0,value:g.batchName,onChange:P,placeholder:"e.g. Batchname Jan 2026"})]}),e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"instructorName",children:"Instructor Assigned"}),e.jsx(Ce,{options:A,value:M,onChange:G,placeholder:"Select Instructor",disabled:A.length===0})]}),e.jsxs("div",{children:[e.jsx(ae,{children:"Mode"}),e.jsx(Ce,{options:U,value:g.mode,onChange:J})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(ae,{htmlFor:"subject",children:"Subject"}),e.jsx(le,{type:"text",id:"subject",name:"subject",required:!0,value:g.subject,onChange:P})]}),e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"startDate",children:"Start Date"}),e.jsx(le,{type:"date",id:"startDate",name:"startDate",required:!0,value:g.startDate,onChange:P})]}),e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"expectedEndDate",children:"Expected End Date"}),e.jsx(le,{type:"date",id:"expectedEndDate",name:"expectedEndDate",required:!0,value:g.expectedEndDate,onChange:P})]}),e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"batchTime.from",children:"Time From"}),e.jsx(le,{type:"time",id:"batchTime.from",name:"batchTime.from",required:!0,value:g.batchTime.from,onChange:P})]}),e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"batchTime.to",children:"Time To"}),e.jsx(le,{type:"time",id:"batchTime.to",name:"batchTime.to",required:!0,value:g.batchTime.to,onChange:P})]})]}),e.jsxs("div",{className:"mt-8 flex flex-col-reverse sm:flex-row sm:justify-end gap-3",children:[e.jsx(se,{type:"button",variant:"outline",onClick:I,className:"w-full sm:w-auto mt-2 sm:mt-0",children:"Cancel"}),e.jsx(se,{type:"submit",variant:"primary",loading:k,className:"w-full sm:w-auto",children:v?"Update Batch":"Create Batch"})]})]})]})}function Ge({batch:n,onUpdate:I,onDelete:c}){var f;const{user:y}=Se(),[u,g]=l.useState(!1),[w,k]=l.useState(!1),[H,A]=l.useState(!1),[E,M]=l.useState(!1),p=y&&n&&y.fullName===n.instructorName||ve(y,"Instructor"),v=xe(y)||me(y)||ue(y)||p,P=xe(y)||me(y)||ue(y),G=()=>g(!u),J=async x=>{if(x.stopPropagation(),window.confirm("Are you sure you want to delete this batch and all its students?"))try{await B.delete(`${L}/batches/${n._id}`,{withCredentials:!0}),h.success("Batch deleted successfully."),c(n._id)}catch{h.error("Failed to delete batch.")}},O=x=>{x.stopPropagation(),k(!0)},U=x=>{I(x),k(!1)};return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",onClick:G,children:[e.jsxs("div",{className:"flex items-start sm:items-center space-x-4 w-full sm:w-auto",children:[e.jsx("div",{className:`transform transition-transform mt-1 sm:mt-0 ${u?"rotate-90":""}`,children:e.jsx("svg",{className:"h-5 w-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:n.batchName}),e.jsxs("div",{className:"flex flex-wrap gap-y-2 gap-x-6 text-sm text-gray-600 dark:text-gray-300",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Subject:"}),e.jsx("span",{children:n.subject})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Duration:"}),e.jsxs("span",{children:[new Date(n.startDate).toLocaleDateString()," - ",new Date(n.expectedEndDate).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Timing:"}),e.jsxs("span",{children:[n.batchTime.from," - ",n.batchTime.to]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Mode:"}),e.jsx("span",{className:`uppercase font-bold text-xs px-2 py-0.5 rounded ${n.mode==="online"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:n.mode})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium text-gray-500 mr-2",children:"Instructor:"}),e.jsx("span",{children:n.instructorName})]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-4 sm:mt-0 w-full sm:w-auto",children:[e.jsx("button",{onClick:x=>{x.stopPropagation(),A(!0)},className:"px-3 py-1 text-xs font-medium bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:bg-indigo-900/50 transition-colors",children:v?"Mark Attendance":"View Attendance"}),e.jsx("button",{onClick:x=>{x.stopPropagation(),M(!0)},className:"px-3 py-1 text-xs font-medium bg-green-50 text-green-600 rounded-full hover:bg-green-100 dark:bg-green-900/30 dark:text-green-400 dark:hover:bg-green-900/50 transition-colors",children:"Monthly Report"}),e.jsxs("button",{onClick:x=>{x.stopPropagation();const j=`${window.location.origin}/public/attendance/${n.shareToken}`;navigator.clipboard.writeText(j).then(()=>{h.info("Shareable link copied to clipboard!")}).catch(a=>{h.error("Failed to copy link.")})},className:"px-3 py-1 text-xs font-medium bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/50 transition-colors flex items-center gap-1",title:"Copy Shareable Link for Students",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})}),"Share Link"]}),P&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:O,className:"p-2 text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400",title:"Edit Batch",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:J,className:"p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400",title:"Delete Batch",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})]}),u&&e.jsx("div",{className:"p-6 border-t border-gray-100 dark:border-gray-700",children:e.jsxs("div",{className:"mt-6",children:[e.jsxs("h5",{className:"text-md font-semibold text-gray-800 dark:text-white mb-4 flex items-center",children:[e.jsx(Re,{className:"h-5 w-5 mr-2 text-gray-400"}),"Enrolled Students"]}),e.jsx(Ue,{batchId:n._id,batchSubject:n.subject,batchStartDate:n.startDate,batchEndDate:n.expectedEndDate,brandName:(f=n.brand)==null?void 0:f.name})]})}),e.jsx(Ve,{isOpen:H,onClose:()=>A(!1),batch:n}),e.jsx(qe,{isOpen:E,onClose:()=>M(!1),batch:n}),w&&e.jsx(Ie,{isOpen:w,onClose:()=>k(!1),onUpdated:U,batch:n})]})}function Xe(){const{user:n}=l.useContext(Te),[I,c]=l.useState([]),[y,u]=l.useState(!0),[g,w]=l.useState(!1),k=xe(n)||me(n)||ue(n);l.useEffect(()=>{H()},[]);const H=async()=>{try{u(!0);const p=await B.get(`${L}/batches`,{withCredentials:!0});c(p.data.batches)}catch(p){console.error("Error fetching batches:",p),h.error("Failed to load batches.")}finally{u(!1)}},A=p=>{c([p,...I]),w(!1)},E=p=>{c(I.map(v=>v._id===p._id?p:v))},M=p=>{c(I.filter(v=>v._id!==p))};return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx(Fe,{title:"Batch Management | DreamCRM",description:"Manage students in structured batches"}),e.jsx(He,{pageTitle:"Batch Management"}),e.jsxs("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-white",children:"Structured Batches"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Manage batches with improved student search and addition."})]}),k&&e.jsx(se,{variant:"primary",onClick:()=>w(!0),className:"w-full sm:w-auto",children:"Create New Batch"})]}),y?e.jsx(fe,{}):I.length>0?e.jsx("div",{className:"space-y-4",children:I.map(p=>e.jsx(Ge,{batch:p,onUpdate:E,onDelete:M},p._id))}):e.jsx(Oe,{children:e.jsxs("div",{className:"text-center py-10",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"No batches found for this brand."}),k&&e.jsx(se,{variant:"outline",onClick:()=>w(!0),children:"Start by creating your first batch"})]})}),g&&e.jsx(Ie,{isOpen:g,onClose:()=>w(!1),onCreated:A}),e.jsx(We,{position:"top-center",autoClose:3e3,className:"!z-[999999]",style:{zIndex:999999}})]})}export{Xe as default};
